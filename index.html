<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>SBC Order Portal</title>
  <style>
    body { font-family: sans-serif; background: #f4f4f9; padding-bottom: 100px; }
    .site-header { background: #1a1a1a; color: white; padding: 15px; display: flex; align-items: center; gap: 20px; border-bottom: 3px solid #007bff; }
    .card { background: white; padding: 20px; border-radius: 8px; max-width: 600px; margin: 20px auto; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .product-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
    .product-row input { width: 50px; text-align: center; }
    .live-bar { position: fixed; bottom: 0; width: 100%; background: white; border-top: 2px solid #007bff; padding: 15px; display: flex; justify-content: space-around; align-items: center; }
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; }
    .modal-content { background: white; padding: 30px; border-radius: 12px; text-align: center; }
    button { padding: 12px 24px; border-radius: 5px; border: none; font-weight: bold; cursor: pointer; }
    .primary { background: #007bff; color: white; }
    .success { background: #28a745; color: white; }
  </style>
</head>
<body>

<header class="site-header">
  <img src="logo.png" style="height: 50px;">
  <div><strong>Suburban Brewing Co</strong><br><small>Remy Davis</small></div>
</header>

<div id="app"></div>

<div id="live-bar" class="live-bar" style="display:none;">
  <strong id="live-total">$0.00</strong>
  <button class="primary" onclick="state.step=3;render()">Review Order</button>
</div>

<div id="success-modal" class="modal">
  <div class="modal-content">
    <h2 style="color:#28a745;">Order Saved!</h2>
    <p>PDF downloaded. Please drag it into <strong>OneDrive</strong>.</p>
    <input type="email" id="c-email" placeholder="Email receipt to client?" style="width: 100%; padding: 10px; margin-bottom: 10px;">
    <button class="success" onclick="handleEmail()">Email Client</button>
    <button onclick="location.reload()">Start New Order</button>
  </div>
</div>

<script>
  const API_URL = "YOUR_APPS_SCRIPT_URL_HERE"; 
  const PRODUCT_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTOYHzF6u43ORNewiUMe-i-FtSGPB4mHw-BN9xlqY-UzHvRWUVr-Cgro_kqiGm4G-fKAA6w3ErQwp3O/pub?gid=1782602603&single=true&output=csv";
  
  let products = [];
  let state = { step: 0, customer: null, cart: [], pdfUrl: "" };

  async function init() {
    const res = await fetch(`${PRODUCT_CSV_URL}&t=${Date.now()}`);
    const text = await res.text();
    products = text.split("\n").slice(1).map(r => ({ name: r.split(",")[0], price: parseFloat(r.split(",")[1]) || 0 }));
    render();
  }

  function render() {
    const app = document.getElementById("app");
    const bar = document.getElementById("live-bar");
    app.innerHTML = ""; bar.style.display = "none";

    if (state.step === 0) {
      app.innerHTML = `<div class="card"><h2>Agreement</h2><button class="primary" onclick="state.step=1;render()">I Agree</button></div>`;
    } else if (state.step === 1) {
      app.innerHTML = `<div class="card"><h2>Search Customer</h2><input type="text" oninput="doSearch(this.value)" placeholder="Company name..."><div id="results"></div></div>`;
    } else if (state.step === 2) {
      bar.style.display = "flex";
      app.innerHTML = `<div class="card"><h2>Items</h2>${products.map((p, i) => `<div class="product-row">${p.name} <input type="number" min="0" oninput="updateCart(${i}, this.value)"></div>`).join("")}</div>`;
    } else if (state.step === 3) {
      app.innerHTML = `<div class="card"><h2>Review</h2><button class="success" onclick="finish()">Confirm & Download PDF</button></div>`;
    }
  }

  async function doSearch(q) {
    if (q.length < 2) return;
    const res = await fetch(`${API_URL}?q=${q}`);
    const data = await res.json();
    document.getElementById("results").innerHTML = data.results.map(c => `<div style="padding:10px; border-bottom:1px solid #eee; cursor:pointer;" onclick='state.customer=${JSON.stringify(c)};state.step=2;render();'>${c.name}</div>`).join("");
  }

  function updateCart(idx, qty) {
    const p = products[idx];
    const item = state.cart.find(x => x.name === p.name);
    if (item) item.qty = parseInt(qty); else state.cart.push({...p, qty: parseInt(qty)});
    const total = state.cart.reduce((s, x) => s + (x.price * x.qty), 0);
    document.getElementById("live-total").innerText = "$" + total.toFixed(2);
  }

  async function finish() {
    document.querySelector(".success").innerText = "Generating...";
    const res = await fetch(API_URL, { method: "POST", body: JSON.stringify({ customer: state.customer, items: state.cart.filter(x => x.qty > 0) }) });
    const data = await res.json();
    state.pdfUrl = data.pdfUrl;
    
    // DOWNLOAD TO LAPTOP
    const link = document.createElement('a');
    link.href = data.pdfUrl;
    link.target = "_blank";
    link.download = `SBC_Order.pdf`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    document.getElementById("success-modal").style.display = "flex";
  }

  async function handleEmail() {
    const email = document.getElementById("c-email").value;
    if(!email) return alert("Missing email");
    await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "emailReceipt", email: email, pdfUrl: state.pdfUrl }) });
    alert("Email Sent");
  }

  init();
</script>
</body>
</html>
