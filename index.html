<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBC Wholesale Portal</title>
    <style>
        :root { --sbc-blue: #007bff; --sbc-dark: #1a1a1a; --bg: #f8f9fa; --border: #dee2e6; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; color: #2d3436; }
        .site-header { background: #fff; padding: 1.5rem 5%; border-bottom: 3px solid var(--sbc-dark); display: flex; flex-direction: column; align-items: flex-start; gap: 10px; }
        .header-info { text-align: left; font-size: 0.95rem; line-height: 1.4; }
        .container { max-width: 1000px; margin: 30px auto; padding: 0 20px; }
        .card { background: white; padding: 2.5rem; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        .legal-scroll { height: 450px; overflow-y: auto; border: 2px solid var(--sbc-dark); padding: 1.5rem; margin: 1.5rem 0; font-size: 0.85rem; line-height: 1.6; background: #fff; }
        .legal-scroll h3 { margin-top: 1.2rem; border-bottom: 1px solid #eee; text-transform: uppercase; font-size: 0.9rem; }
        .checkbox-area { background: #f1f2f6; padding: 1.2rem; border-radius: 8px; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 12px; border: 1px solid #dfe6e9; font-weight: bold; }
        .checkbox-area input { transform: scale(1.4); }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.5rem; }
        .product-card { background: #fff; border: 1px solid var(--border); border-radius: 8px; text-align: center; padding: 10px; }
        .live-bar { position: fixed; bottom: 0; left: 0; right: 0; background: var(--sbc-dark); color: white; padding: 1.2rem 8%; display: flex; justify-content: space-between; align-items: center; z-index: 1001; }
        .btn { padding: 12px 24px; border: none; border-radius: 6px; font-weight: 800; cursor: pointer; text-transform: uppercase; }
        .btn-primary { background: var(--sbc-blue); color: white; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .review-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .review-table th { text-align: left; border-bottom: 2px solid #000; padding: 10px; }
        .review-table td { padding: 10px; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

<header class="site-header">
    <img src="https://raw.githubusercontent.com/remyjdavis/brewery-order-form/main/logo.png" style="height:60px;">
    <div class="header-info">
        <h1 style="margin:0; font-size:1.6rem;">Suburban Brewing Co.</h1>
        3041 Horseshoe Pike, Honey Brook, PA 19344<br>
        <strong>Sales Rep: Remy Davis</strong> | (908) 642-1019
    </div>
</header>

<div class="container" id="app"></div>

<div id="live-bar" class="live-bar" style="display:none;">
    <div>TOTAL: <span id="live-total" style="color:var(--sbc-blue); font-weight:900; font-size:1.5rem;">$0.00</span></div>
    <button class="btn btn-primary" onclick="state.step=3;render()">Review Order Details</button>
</div>

<script>
    const API_URL = "PASTE_YOUR_NEW_WEB_APP_URL_HERE"; 
    const PRODUCT_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTOYHzF6u43ORNewiUMe-i-FtSGPB4mHw-BN9xlqY-UzHvRWUVr-Cgro_kqiGm4G-fKAA6w3ErQwp3O/pub?gid=1782602603&output=csv";

    let groupedProducts = {};
    let state = { step: 0, customer: null, cart: {} };

    async function init() {
        const res = await fetch(PRODUCT_CSV);
        const text = await res.text();
        const rows = text.split("\n").slice(1);
        rows.forEach(r => {
            const c = r.split(","); if (!c[0]) return;
            const cleanName = c[0].replace(/(Keg|Case|1\/2|1\/6|BBL|Can)/gi, '').trim();
            if (!groupedProducts[cleanName]) groupedProducts[cleanName] = { name: cleanName, img: c[3] || '', options: [] };
            groupedProducts[cleanName].options.push({ type: c[0].replace(cleanName, '').trim() || "Unit", price: parseFloat(c[1]) || 0 });
        });
        render();
    }

    async function attemptLogin() {
        const key = document.getElementById("loginInput").value.trim();
        const btn = document.getElementById("loginBtn");
        btn.innerText = "VERIFYING...";
        const res = await fetch(`${API_URL}?key=${encodeURIComponent(key)}`);
        const data = await res.json();
        if (data.success) { state.customer = data.customer; state.step = 2; render(); }
        else { alert("Invalid Key"); btn.innerText = "LOG IN"; }
    }

    function render() {
        const app = document.getElementById("app");
        document.getElementById("live-bar").style.display = (state.step === 2) ? "flex" : "none";

        if (state.step === 0) {
            app.innerHTML = `
            <div class="card">
                <h2>Wholesale Purchase Agreement</h2>
                <div class="legal-scroll">
                    <h3>1. PA Liquor Code Compliance</h3>
                    <p>Purchaser warrants a valid PLCB license. All sales are per Section 493(2) requiring payment at or before delivery.</p>
                    <h3>2. Cooperage & Kegs</h3>
                    <p>All keg shells remain SBC property. A $30.00 deposit is required. Unreturned or damaged shells will be billed at $145.00 each.</p>
                    <h3>3. Bounced Checks</h3>
                    <p>Returned checks (NSF) incur a $50.00 fee. Account will move to Cash-Only status immediately.</p>
                    <h3>4. Cold Chain</h3>
                    <p>Products are unpasteurized. Storage must be 34°F-38°F. SBC is not liable for spoilage due to improper cooling.</p>
                </div>
                <div class="checkbox-area">
                    <input type="checkbox" id="agree" onchange="document.getElementById('next').disabled = !this.checked">
                    <label for="agree">I agree to the terms of this agreement.</label>
                </div>
                <button id="next" class="btn btn-primary" style="width:100%" disabled onclick="state.step=1;render()">Continue</button>
            </div>`;
        } else if (state.step === 1) {
            app.innerHTML = `<div class="card" style="max-width:400px; margin:auto; text-align:center;">
                <h3>Account Login</h3>
                <input type="text" id="loginInput" placeholder="Enter Key" style="width:100%; padding:15px; margin-bottom:15px; border:2px solid #000; font-size:1.2rem; text-align:center;">
                <button id="loginBtn" class="btn btn-primary" style="width:100%" onclick="attemptLogin()">Log In</button>
            </div>`;
        } else if (state.step === 2) {
            app.innerHTML = `<h3>Ordering for: ${state.customer.name}</h3><div class="product-grid">${Object.values(groupedProducts).map(p => {
                const id = p.name.replace(/\s/g,'');
                return `<div class="product-card">
                    <h4>${p.name}</h4>
                    <select id="s-${id}" style="width:100%; padding:5px;">${p.options.map((o,i)=>`<option value="${i}">${o.type} - $${o.price}</option>`).join('')}</select>
                    <br><br>Qty: <input type="number" id="q-${id}" style="width:60px;" oninput="updateCart('${p.name}','s-${id}','q-${id}')">
                </div>`;
            }).join('')}</div>`;
        } else if (state.step === 3) {
            let total = 0; Object.values(state.cart).forEach(i => total += (i.price * i.qty));
            app.innerHTML = `<div class="card">
                <div style="display:flex; justify-content:space-between;">
                    <div>
                        <strong>Suburban Brewing Co.</strong><br>3041 Horseshoe Pike<br>Honey Brook, PA 19344<br>
                        <strong>Sales Rep: Remy Davis</strong>
                    </div>
                    <div style="text-align:right;">
                        <strong>ORDER DATE:</strong><br>${new Date().toLocaleDateString()}
                    </div>
                </div>
                <div style="margin-top:30px;">
                    <strong style="font-size:1.2rem;">${state.customer.name}</strong><br>
                    ${state.customer.address}<br>
                    ${state.customer.city}, ${state.customer.state} ${state.customer.zip}
                </div>
                <table class="review-table">
                    <thead><tr><th>Product</th><th>Qty</th><th>Subtotal</th></tr></thead>
                    <tbody>${Object.values(state.cart).map(i=>`<tr><td>${i.beer} (${i.type})</td><td>${i.qty}</td><td>$${(i.qty*i.price).toFixed(2)}</td></tr>`).join('')}</tbody>
                </table>
                <h2 style="text-align:right;">TOTAL: $${total.toFixed(2)}</h2>
                <div style="margin-top:30px; display:flex; gap:10px;">
                    <button class="btn" style="flex:1; border:1px solid #ccc;" onclick="state.step=2;render()">Edit Order</button>
                    <button class="btn btn-primary" style="flex:2; background:green;" onclick="submitOrder()">Confirm & Submit</button>
                </div>
            </div>`;
        }
    }

    function updateCart(beer, sId, qId) {
        const opt = groupedProducts[beer].options[document.getElementById(sId).value];
        const qty = parseInt(document.getElementById(qId).value) || 0;
        if (qty > 0) state.cart[`${beer}-${opt.type}`] = { beer, type: opt.type, price: opt.price, qty };
        else delete state.cart[`${beer}-${opt.type}`];
        let t = 0; Object.values(state.cart).forEach(i => t += (i.price * i.qty));
        document.getElementById("live-total").innerText = "$" + t.toFixed(2);
    }

    async function submitOrder() {
        await fetch(API_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(state) });
        alert("Order Submitted!"); location.reload();
    }

    init();
</script>
</body>
</html>
