<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBC Wholesale Portal</title>
    <style>
        :root { --sbc-blue: #007bff; --sbc-dark: #1a1a1a; --bg: #f4f7f9; }
        body { font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; background: var(--bg); margin: 0; padding-bottom: 120px; }
        .site-header { background: #fff; padding: 30px 5%; border-bottom: 5px solid var(--sbc-dark); display: flex; align-items: center; gap: 25px; }
        .site-header img { height: 85px; }
        .container { max-width: 900px; margin: 40px auto; padding: 0 20px; }
        .card { background: white; padding: 40px; border-radius: 4px; border: 1px solid #e1e4e8; }
        .legal-scroll { height: 350px; overflow-y: scroll; border: 1px solid #ddd; padding: 20px; font-size: 0.85em; margin: 20px 0; }
        .live-bar { position: fixed; bottom: 0; left: 0; right: 0; background: var(--sbc-dark); color: white; padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; z-index: 999; }
        .btn { padding: 12px 25px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; text-transform: uppercase; }
        .btn-success { background: #28a745; color: white; width: 100%; font-size: 1.2em; }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
        .product-card { border: 1px solid #eee; padding: 15px; text-align: center; }
        .review-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .review-table th, .review-table td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
    </style>
</head>
<body>

<header class="site-header" id="main-header">
    <img src="https://raw.githubusercontent.com/remyjdavis/brewery-order-form/main/logo.png" alt="SBC Logo">
    <div><h1>Suburban Brewing Co.</h1><p>3041 Horseshoe Pike, Honey Brook, PA 19344</p></div>
</header>

<div class="container" id="app"></div>

<div id="live-bar" class="live-bar" style="display:none;">
    <div>Total: <span id="live-total" style="color:var(--sbc-blue);">$0.00</span></div>
    <button class="btn btn-primary" onclick="state.step=3;render()">Review Order</button>
</div>

<script>
    const API_URL = "YOUR_DEPLOYED_URL_HERE";
    const PRODUCT_CSV = "YOUR_CSV_URL_HERE";
    let products = [];
    let state = { step: 0, customer: null, cart: [], overrideActive: false };

    async function init() {
        const res = await fetch(PRODUCT_CSV);
        const text = await res.text();
        const rows = text.split("\n").slice(1);
        products = rows.map(r => {
            const c = r.split(",");
            return { name: c[0]?.trim(), price: parseFloat(c[1]) || 0, stock: parseInt(c[6]) || 0 };
        }).filter(p => p.name);
        render();
    }

    function calculate() {
        let sub = 0, totalQty = 0, dep = 0;
        state.cart.forEach(i => { if (i.qty > 0) { sub += (i.price * i.qty); totalQty += i.qty; if (i.name.toLowerCase().includes("keg")) dep += (i.qty * 30); } });
        const disc = (totalQty >= 10) ? (sub * 0.10) : 0;
        const tax = (state.customer?.name.toLowerCase().includes("restaurant")) ? ((sub - disc) * 0.06) : 0;
        return { sub, disc, dep, tax, final: (sub - disc + dep + tax) };
    }

    function render() {
        const app = document.getElementById("app");
        document.getElementById("live-bar").style.display = (state.step === 2) ? "flex" : "none";
        app.innerHTML = "";

        if (state.step === 0) {
            app.innerHTML = `<div class="card"><h2>Wholesale Agreement</h2><div class="legal-scroll"><h4>Section 1... (Wording Here)</h4></div><button class="btn btn-success" onclick="state.step=1;render()">Accept & Continue</button></div>`;
        } else if (state.step === 1) {
            app.innerHTML = `<div class="card"><h2>Account Search</h2><input type="text" placeholder="Search business..." oninput="doSearch(this.value)"><div id="results"></div></div>`;
        } else if (state.step === 2) {
            app.innerHTML = `<div class="card"><h3>Ordering for: ${state.customer.name}</h3><div class="product-grid">${products.map(p => `
                <div class="product-card"><strong>${p.name}</strong><br>$${p.price}<br><input type="number" min="0" value="${getQty(p.name)}" oninput="updateCart('${p.name}', ${p.price}, this.value)"></div>`).join("")}</div></div>`;
        } else if (state.step === 3) {
            const t = calculate();
            app.innerHTML = `
                <div class="card">
                    <div style="border-bottom:5px solid #111; padding-bottom:15px; margin-bottom:20px; display:flex; align-items:center; gap:20px;">
                        <img src="https://raw.githubusercontent.com/remyjdavis/brewery-order-form/main/logo.png" style="height:70px;">
                        <div><strong>Suburban Brewing Co.</strong><br>Remy Davis | (908) 642-1019</div>
                    </div>
                    <div style="display:flex; justify-content:space-between;">
                        <div><strong>BILL TO:</strong><br>${state.customer.name}<br>${state.customer.address}<br>${state.customer.city}, ${state.customer.state} ${state.customer.zip}</div>
                        <div style="text-align:right;"><strong>DATE:</strong><br>${new Date().toLocaleDateString()}</div>
                    </div>
                    <table class="review-table"><thead><tr><th>Item</th><th>Qty</th><th>Total</th></tr></thead>
                    <tbody>${state.cart.filter(i => i.qty > 0).map(i => `<tr><td>${i.name}</td><td>${i.qty}</td><td>$${(i.qty*i.price).toFixed(2)}</td></tr>`).join("")}</tbody></table>
                    <div style="text-align:right; margin-top:20px;"><strong>TOTAL: $${t.final.toFixed(2)}</strong></div>
                    <div style="margin-top:20px; padding:15px; border:1px solid #007bff;">
                        <label><input type="checkbox" id="want-email" onchange="document.getElementById('email-box').style.display=this.checked?'block':'none'"> Email me a copy of this invoice</label>
                        <div id="email-box" style="display:none; margin-top:10px;"><input type="email" id="cust-email" style="width:100%; padding:10px;" placeholder="Enter email..."></div>
                    </div>
                    <button class="btn btn-success" style="margin-top:20px;" onclick="submitOrder()">Submit Final Order</button>
                </div>`;
        }
    }

    async function submitOrder() {
        const want = document.getElementById("want-email").checked;
        const email = document.getElementById("cust-email").value;
        if (want && !email) return alert("Enter email");
        await fetch(API_URL, { method: "POST", body: JSON.stringify({ ...state, totals: calculate(), recipientEmail: want ? email : null }) });
        alert("Order Sent!"); location.reload();
    }
    async function doSearch(v) { if(v.length<3) return; const res = await fetch(API_URL+"?q="+v); const d = await res.json(); document.getElementById("results").innerHTML = d.results.map(c => `<div onclick='state.customer=${JSON.stringify(c)};state.step=2;render()'>${c.name}</div>`).join(""); }
    function updateCart(n, p, q) { const idx = state.cart.findIndex(i => i.name === n); if (idx > -1) state.cart[idx].qty = parseInt(q); else state.cart.push({name:n, price:p, qty:parseInt(q)}); document.getElementById("live-total").innerText = "$"+calculate().final.toFixed(2); }
    function getQty(n) { return state.cart.find(i => i.name === n)?.qty || 0; }
    init();
</script>
</body>
</html>
