<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBC Wholesale Portal</title>
    <style>
        :root { --sbc-blue: #007bff; --sbc-dark: #1a1a1a; --bg: #f4f7f9; --red: #d9534f; }
        body { font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; background: var(--bg); margin: 0; padding-bottom: 120px; color: #333; }
        
        .site-header { background: #fff; padding: 30px 5%; border-bottom: 5px solid var(--sbc-dark); display: flex; align-items: center; gap: 25px; }
        .site-header img { height: 85px; }
        
        .container { max-width: 1000px; margin: 40px auto; padding: 0 20px; }
        .card { background: white; padding: 40px; border-radius: 4px; border: 1px solid #e1e4e8; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        
        /* Legal Section */
        .legal-scroll { height: 400px; overflow-y: scroll; border: 1px solid #ddd; padding: 25px; background: #fafafa; font-size: 0.85em; line-height: 1.6; margin: 20px 0; border-radius: 4px; }
        .legal-scroll h4 { margin-top: 20px; border-bottom: 1px solid #eee; text-transform: uppercase; color: var(--sbc-dark); }

        /* Product Grid & Cards */
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; margin-top: 30px; }
        .product-card { border: 1px solid #eee; padding: 0; text-align: center; border-radius: 8px; background: #fff; overflow: hidden; display: flex; flex-direction: column; }
        .product-img { width: 100%; height: 180px; object-fit: cover; background: #eee; border-bottom: 1px solid #eee; }
        .product-info { padding: 20px; flex-grow: 1; }
        
        .type-select { width: 100%; padding: 10px; margin: 10px 0; border-radius: 4px; border: 1px solid #ccc; font-weight: bold; }
        .qty-input { width: 80px; padding: 10px; text-align: center; font-weight: bold; border: 1px solid #ccc; border-radius: 4px; font-size: 1.1em; }
        .qty-input.error { border: 2px solid var(--red); background: #fff1f0; }

        .live-bar { position: fixed; bottom: 0; left: 0; right: 0; background: var(--sbc-dark); color: white; padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; z-index: 9999; border-top: 4px solid var(--sbc-blue); }
        
        .btn { padding: 12px 25px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; text-transform: uppercase; transition: all 0.2s; }
        .btn-primary { background: var(--sbc-blue); color: white; }
        .btn-success { background: #28a745; color: white; width: 100%; margin-top: 20px; font-size: 1.2em; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-outline { background: transparent; border: 1px solid #ccc; color: #333; }

        .stock-badge { font-size: 0.7em; font-weight: bold; padding: 3px 8px; border-radius: 12px; display: inline-block; margin-top: 5px; }
        .in-stock { background: #e6ffed; color: #22863a; }
        .out-of-stock { background: #ffeef0; color: #d73a49; }

        .review-table { width: 100%; border-collapse: collapse; margin-top: 25px; }
        .review-table th { text-align: left; padding: 12px; border-bottom: 2px solid #333; }
        .review-table td { padding: 12px; border-bottom: 1px solid #eee; }

        @media print {
            .live-bar, .btn, .action-flex, #admin-link { display: none !important; }
            body { background: white; padding: 0; }
            .card { border: none; box-shadow: none; padding: 0; }
        }
    </style>
</head>
<body>

<header class="site-header" id="main-header">
    <img src="https://raw.githubusercontent.com/remyjdavis/brewery-order-form/main/logo.png" alt="SBC Logo">
    <div class="header-text">
        <h1>Suburban Brewing Co.</h1>
        <p>3041 Horseshoe Pike, Honey Brook, PA 19344<br>
        <strong>Sales Rep: Remy Davis</strong> | (908) 642-1019<br>
        remyjdavis90@gmail.com</p>
    </div>
</header>

<div class="container" id="app"></div>

<div id="live-bar" class="live-bar" style="display:none;">
    <div id="stock-error" style="color:var(--red); font-weight:bold; display:none;">⚠️ QUANTITY EXCEEDS STOCK</div>
    <div class="summary-item">Total: <span id="live-total" style="color:var(--sbc-blue); font-size: 1.4em;">$0.00</span></div>
    <button class="btn btn-primary" id="review-btn" onclick="goToReview()">Review Order</button>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyT1PzljxVZ9NKBbgmAJ7kgPul228vnwrdjf_YRbzhIMR_rXhG2tx36-yzBHfFNH5DX/exec";
    const PRODUCT_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTOYHzF6u43ORNewiUMe-i-FtSGPB4mHw-BN9xlqY-UzHvRWUVr-Cgro_kqiGm4G-fKAA6w3ErQwp3O/pub?gid=1782602603&output=csv";

    let groupedProducts = {};
    let state = { step: 0, customer: null, cart: {}, overrideActive: false, emailRequested: false };

    async function init() {
        try {
            const res = await fetch(PRODUCT_CSV);
            const text = await res.text();
            const rows = text.split("\n").slice(1);
            
            // Assume CSV Structure: Beer Name, Price, Qty In Stock, Image URL, Format Type
            rows.forEach(r => {
                const c = r.split(",");
                const name = c[0]?.trim();
                if (!name) return;
                
                if (!groupedProducts[name]) groupedProducts[name] = { name, img: c[3]?.trim() || '', options: [] };
                groupedProducts[name].options.push({
                    type: c[4]?.trim() || 'Unit',
                    price: parseFloat(c[1]) || 0,
                    stock: parseInt(c[2]) || 0
                });
            });
            render();
        } catch (e) { console.error("Data error", e); }
    }

    function calculate() {
        let sub = 0, totalQty = 0, dep = 0, overStock = false;
        Object.keys(state.cart).forEach(key => {
            const item = state.cart[key];
            if (item.qty > 0) {
                sub += (item.price * item.qty);
                totalQty += item.qty;
                if (item.type.toLowerCase().includes("bbl")) dep += (item.qty * 30);
                if (!state.overrideActive && item.qty > item.max) overStock = true;
            }
        });
        const disc = (totalQty >= 10) ? (sub * 0.10) : 0;
        const tax = (state.customer && /restaurant|bar|pub|grill|cafe/i.test(state.customer.name)) ? ((sub - disc) * 0.06) : 0;
        return { sub, disc, dep, tax, final: (sub - disc + dep + tax), overStock };
    }

    function updateCart(beerName, selectElement, qtyValue) {
        const typeIndex = selectElement.value;
        const option = groupedProducts[beerName].options[typeIndex];
        const key = `${beerName}-${option.type}`;
        const qty = Math.max(0, parseInt(qtyValue) || 0);

        if (qty > 0) {
            state.cart[key] = { beer: beerName, type: option.type, price: option.price, qty: qty, max: option.stock };
        } else {
            delete state.cart[key];
        }
        updateBar();
    }

    function render() {
        const app = document.getElementById("app");
        const bar = document.getElementById("live-bar");
        app.innerHTML = "";
        bar.style.display = (state.step === 2) ? "flex" : "none";

        if (state.step === 0) {
            app.innerHTML = `<div class="card"><h2 style="text-align:center;">Wholesale Agreement</h2><div class="legal-scroll"><h4>1. STORAGE</h4><p>Must keep at 38°F.</p><h4>2. PAYMENT</h4><p>Due at delivery or via Fintech.</p><h4>3. COOPERAGE</h4><p>$30 deposit per keg.</p><h4>4. LIABILITY</h4><p>Purchaser assumes all responsibility for service.</p></div><label style="display:block; text-align:center; margin-bottom:20px;"><input type="checkbox" id="agree"> I Agree</label><button class="btn btn-primary" style="width:100%" onclick="if(document.getElementById('agree').checked){state.step=1;render()}">Continue</button></div>`;
        } else if (state.step === 1) {
            app.innerHTML = `<div class="card"><h2>Account Search</h2><input type="text" placeholder="Search..." oninput="doSearch(this.value)" style="width:100%; padding:12px; border:1px solid #ccc; border-radius:4px;"><div id="results"></div></div>`;
        } else if (state.step === 2) {
            app.innerHTML = `<div class="card"><h3>Ordering for: ${state.customer.name}</h3><div class="product-grid">${Object.values(groupedProducts).map(p => `
                <div class="product-card">
                    <img src="${p.img || 'https://via.placeholder.com/300x180?text=No+Image'}" class="product-img">
                    <div class="product-info">
                        <strong>${p.name}</strong><br>
                        <select class="type-select" id="select-${p.name}" onchange="updateCart('${p.name}', this, document.getElementById('qty-${p.name}').value)">
                            ${p.options.map((opt, idx) => `<option value="${idx}">${opt.type} - $${opt.price.toFixed(2)} (${opt.stock} in stock)</option>`).join("")}
                        </select>
                        <input type="number" id="qty-${p.name}" class="qty-input" placeholder="0" min="0" oninput="updateCart('${p.name}', document.getElementById('select-${p.name}'), this.value)">
                    </div>
                </div>`).join("")}</div></div>`;
        } else if (state.step === 3) {
            const t = calculate();
            app.innerHTML = `
                <div class="card">
                    <div style="display:flex; justify-content:space-between; margin-bottom:30px;">
                        <div><strong>BILL TO:</strong><br>${state.customer.name}<br>${state.customer.address}<br>${state.customer.city}, ${state.customer.state} ${state.customer.zip}</div>
                        <div style="text-align:right;"><strong>DATE:</strong><br>${new Date().toLocaleDateString()}</div>
                    </div>
                    <table class="review-table">
                        <thead><tr><th>Beer</th><th>Type</th><th>Qty</th><th>Total</th></tr></thead>
                        <tbody>${Object.values(state.cart).map(i => `<tr><td>${i.beer}</td><td>${i.type}</td><td>${i.qty}</td><td>$${(i.price*i.qty).toFixed(2)}</td></tr>`).join("")}</tbody>
                    </table>
                    <div style="text-align:right; margin-top:20px;">
                        Subtotal: $${t.sub.toFixed(2)}<br>
                        Tax: $${t.tax.toFixed(2)}<br>
                        Keg Deposits: $${t.dep.toFixed(2)}<br>
                        <strong>Total: $${t.final.toFixed(2)}</strong>
                    </div>
                    <div style="display:flex; gap:10px; margin-top:20px;">
                        <button class="btn btn-secondary" onclick="state.step=2;render()">Back</button>
                        <button class="btn btn-outline" onclick="handleEmailRequest()">${state.emailRequested ? 'Email Queued ✓' : 'Email Invoice'}</button>
                    </div>
                    <button class="btn btn-success" onclick="submitOrder()">Submit Final Order</button>
                </div>`;
        }
    }

    function updateBar() {
        const t = calculate();
        document.getElementById("live-total").innerText = "$" + t.final.toFixed(2);
        document.getElementById("stock-error").style.display = t.overStock ? "block" : "none";
        document.getElementById("review-btn").disabled = t.overStock;
    }

    async function doSearch(v) {
        if (v.length < 2) return;
        const res = await fetch(`${API_URL}?q=${encodeURIComponent(v)}`);
        const data = await res.json();
        document.getElementById("results").innerHTML = data.results.map(c => `<div style="padding:15px; border-bottom:1px solid #eee; cursor:pointer;" onclick='selectCust(${JSON.stringify(c).replace(/'/g, "&apos;")})'><strong>${c.name}</strong></div>`).join("");
    }

    function handleEmailRequest() {
        if (!state.customer.email) state.customer.email = prompt("Enter Client Email:");
        state.emailRequested = true;
        render();
    }

    window.selectCust = (c) => { state.customer = c; state.step = 2; render(); };
    function goToReview() { state.step = 3; render(); }

    async function submitOrder() {
        const payload = { ...state, subject: `Suburban Brewing Company Order - ${state.customer.name}` };
        await fetch(API_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(payload) });
        alert("Order Received!");
        location.reload();
    }

    init();
</script>
</body>
</html>
