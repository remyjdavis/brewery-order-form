<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>SBC Wholesale Portal</title>
  <style>
    body { font-family: -apple-system, system-ui, sans-serif; background: #f4f4f9; margin: 0; padding-bottom: 110px; color: #333; }
    
    /* MAIN HEADER */
    .site-header { background: #1a1a1a; color: white; padding: 15px 5%; border-bottom: 3px solid #007bff; }
    .header-content { display: flex; align-items: center; gap: 20px; max-width: 1000px; margin: 0 auto; }
    .header-brand img { height: 60px; background: white; border-radius: 4px; padding: 4px; }
    .header-contact { font-size: 0.75em; line-height: 1.4; opacity: 0.9; }
    .header-contact strong { font-size: 1.1em; color: #007bff; display: block; margin-bottom: 2px; }
    
    .card { background: white; padding: 18px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); width: 92%; max-width: 1000px; margin: 12px auto; }
    .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; }
    .product-card { border: 1px solid #eee; padding: 10px; border-radius: 10px; background: #fff; text-align: center; }
    .qty-input { width: 70%; padding: 6px; border: 1.5px solid #007bff; border-radius: 6px; text-align: center; font-weight: bold; font-size: 0.9em; }
    
    .live-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #1a1a1a; color: white; border-top: 3px solid #007bff; padding: 12px 5%; display: flex; justify-content: space-between; align-items: center; z-index: 1000; }
    
    button { padding: 8px 16px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; font-size: 0.8em; }
    button:disabled { background: #ccc !important; cursor: not-allowed; }
    .primary { background: #007bff; color: white; width: 100%; height: 38px; }
    .success { background: #28a745; color: white; width: 100%; height: 42px; font-size: 0.9em; }
    .secondary { background: #eee; color: #444; width: 100%; margin-top: 8px; }
    
    .dropdown { position: absolute; width: 100%; background: white; border: 1px solid #ddd; z-index: 5000; display: none; max-height: 250px; overflow-y: auto; }
    .dropdown-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 0.9em; }

    .summary-row { display: flex; justify-content: flex-end; padding: 3px 0; font-size: 0.9em; }
    .summary-label { width: 220px; text-align: right; color: #666; padding-right: 15px; }
    .summary-val { width: 100px; text-align: right; font-weight: bold; }
    .grand-total { border-top: 2px solid #1a1a1a; margin-top: 8px; padding-top: 8px; font-size: 1.4em; color: #1a1a1a; }

    @media print {
        body * { visibility: hidden; }
        #receipt-printable, #receipt-printable * { visibility: visible; }
        #receipt-printable { position: absolute; left: 0; top: 0; width: 100%; box-shadow: none; border: none; }
        #post-order-actions, .site-header, .live-bar { display: none !important; }
    }
  </style>
</head>
<body>

<header class="site-header">
  <div class="header-content">
    <div class="header-brand">
      <img src="https://raw.githubusercontent.com/remyjdavis/brewery-order-form/main/logo.png" alt="SBC">
    </div>
    <div class="header-contact">
      <strong>Suburban Brewing Co.</strong>
      3041 Horseshoe Pike, Suite 120 & 130, Honey Brook, PA 19344<br>
      Remy Davis | (908) 642-1019 | remyjdavis90@gmail.com
    </div>
  </div>
</header>

<main id="app"></main>

<div id="live-bar" class="live-bar" style="display:none;">
  <div style="line-height:1.2;">
    <small id="savings-label" style="color: #2ecc71; font-weight:700; font-size:0.65em; text-transform:uppercase; display:block;"></small>
    <small id="tax-label" style="color: #aaa; font-size:0.65em; display:block;"></small>
    <strong id="live-total" style="font-size:1.4em;">$0.00</strong>
  </div>
  <button style="background:#007bff; color:white;" onclick="state.step=3;render()">Review Order &rarr;</button>
</div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbyT1PzljxVZ9NKBbgmAJ7kgPul228vnwrdjf_YRbzhIMR_rXhG2tx36-yzBHfFNH5DX/exec";
  const PRODUCT_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTOYHzF6u43ORNewiUMe-i-FtSGPB4mHw-BN9xlqY-UzHvRWUVr-Cgro_kqiGm4G-fKAA6w3ErQwp3O/pub?gid=1782602603&single=true&output=csv";
  
  let products = [];
  let state = { step: 0, customer: null, cart: [] };

  async function init() {
    try {
      const res = await fetch(`${PRODUCT_CSV_URL}&t=${Date.now()}`);
      const text = await res.text();
      const rows = text.split("\n").slice(1);
      products = rows.map(r => {
        const c = r.split(",");
        return { name: c[0].trim(), price: parseFloat(c[1]) || 0 };
      }).filter(p => p.name);
      render();
    } catch(e) { console.error(e); }
  }

  function checkIsRestaurant(name) {
    if (!name) return false;
    const keywords = ["restaurant", "pub", "grill", "cafe", "bistro", "tavern", "kitchen", "inn", "bar"];
    const lowerName = name.toLowerCase();
    return keywords.some(word => lowerName.includes(word));
  }

  function render() {
    const app = document.getElementById("app");
    const bar = document.getElementById("live-bar");
    app.innerHTML = ""; bar.style.display = "none";

    // STEP 0: THE LONG USER AGREEMENT
    if (state.step === 0) {
      app.innerHTML = `<div class="card">
        <h2 style="font-size:1.1em; border-bottom:2px solid #007bff; padding-bottom:8px;">Wholesale Purchase & Distribution Agreement</h2>
        <div style="font-size:0.8em; max-height: 350px; overflow-y: auto; border: 1px solid #eee; padding: 15px; margin: 15px 0; background: #fafafa; line-height: 1.6; color: #444;">
            <p><strong>1. PROOF OF LICENSURE:</strong> By proceeding, the Purchaser warrants that they hold a valid retail liquor license issued by the Pennsylvania Liquor Control Board (PLCB) and are authorized to purchase malt or brewed beverages for resale.</p>
            
            <p><strong>2. PRICING & TAXES:</strong> Prices are subject to change without notice. In accordance with PA state law, sales tax (6%) will be applied to all retail/restaurant accounts. Beer Distributors and other tax-exempt entities must provide a valid tax exemption certificate on file.</p>
            
            <p><strong>3. KEG DEPOSITS & RETURNS:</strong> A standard deposit of $30.00 will be charged for every keg delivered. This deposit is refundable upon the return of the empty keg in good condition. Purchaser is responsible for the safety and storage of all cooperage while in their possession.</p>
            
            <p><strong>4. PAYMENT TERMS:</strong> Payment is due upon delivery unless otherwise agreed upon. Fintech accounts will be processed automatically. For "Check" accounts, payment must be ready at the time of delivery. Failure to provide payment may result in the order being returned to the brewery and a delivery fee assessed.</p>
            
            <p><strong>5. BULK DISCOUNTS:</strong> A 10% discount is automatically applied to orders of 10 or more total units (cases or kegs combined). This discount applies to the base product price before tax and deposits.</p>
            
            <p><strong>6. PRODUCT QUALITY & HANDLING:</strong> Suburban Brewing Co. products are unpasteurized and must be kept refrigerated at all times (recommended 38°F). Suburban Brewing Co. is not liable for product degradation due to improper storage or handling by the Purchaser.</p>
            
            <p><strong>7. LIMITATION OF LIABILITY:</strong> Suburban Brewing Co. shall not be liable for any indirect, incidental, or consequential damages resulting from the use of this portal or the distribution of its products.</p>
            
            <p><strong>8. ACCEPTANCE:</strong> By checking the box below and clicking "I Agree," you acknowledge that you have read, understood, and agree to be bound by these terms.</p>
        </div>
        <label style="display:flex; align-items:center; gap:12px; margin-bottom:20px; font-size:0.9em; cursor:pointer; background: #eef6ff; padding: 12px; border-radius: 6px;">
            <input type="checkbox" id="agree-cb" style="transform: scale(1.3);" onchange="document.getElementById('proceed-btn').disabled = !this.checked"> 
            <strong>I have read and agree to the Wholesale Purchase Terms.</strong>
        </label>
        <button id="proceed-btn" class="primary" disabled onclick="state.step=1;render()">I Agree & Proceed to Account Selection</button>
      </div>`;
    }
    else if (state.step === 1) {
      app.innerHTML = `<div class="card">
        <h2 style="font-size:1em;">Account Selection</h2>
        <input type="text" id="cust-input" placeholder="Search for account name..." style="width:100%; padding:10px; border-radius:6px; border:2px solid #ddd; font-size:0.95em; box-sizing:border-box;">
        <div id="results" class="dropdown"></div>
      </div>`;
      document.getElementById("cust-input").oninput = (e) => doSearch(e.target.value);
    } 
    else if (state.step === 2) {
      bar.style.display = "flex";
      app.innerHTML = `<div class="card">
        <h3 style="margin:0 0 12px 0; font-size:0.95em; color:#007bff;">${state.customer.name}</h3>
        <div class="product-grid">${products.map((p, i) => `
          <div class="product-card">
            <span style="font-weight:700; display:block; height:30px; font-size:0.8em;">${p.name}</span>
            <span style="color:#007bff; font-weight:800; display:block; margin:5px 0; font-size:0.95em;">$${p.price.toFixed(2)}</span>
            <input type="number" class="qty-input" min="0" value="${getQty(p.name) || ''}" oninput="updateCart(${i}, this.value)">
          </div>`).join("")}
        </div>
      </div>`;
      updateLiveDisplay();
    }
    else if (state.step === 3) {
      const items = state.cart.filter(i => i.qty > 0);
      const subtotal = items.reduce((s, i) => s + (i.price * i.qty), 0);
      const kegCount = items.reduce((s, i) => s + (i.name.toLowerCase().includes("keg") ? i.qty : 0), 0);
      const kegDeposit = kegCount * 30.00;
      const discount = (items.reduce((s, i) => s + i.qty, 0) >= 10) ? subtotal * 0.10 : 0;
      const taxableAmount = subtotal - discount;
      const taxRate = checkIsRestaurant(state.customer.name) ? 0.06 : 0;
      const tax = taxableAmount * taxRate;
      const grandTotal = taxableAmount + tax + kegDeposit;

      app.innerHTML = `
      <div class="card" id="receipt-printable">
        <h2 style="font-size:1.2em; border-bottom:2px solid #007bff; padding-bottom:8px; margin-bottom:12px;">Order Summary</h2>
        <div style="display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 0.8em;">
            <div>
                <strong>Suburban Brewing Co.</strong><br>
                3041 Horseshoe Pike, Honey Brook, PA<br>
                Remy Davis | (908) 642-1019 | remyjdavis90@gmail.com
            </div>
            <div style="text-align: right;"><strong>Date:</strong> ${new Date().toLocaleDateString()}</div>
        </div>
        <div style="margin-bottom: 18px; font-size: 0.9em; line-height: 1.4; border-top: 1px solid #eee; padding-top: 10px;">
            <div style="font-weight: bold; color: #007bff;">${state.customer.name}</div>
            <div>${state.customer.address}</div>
            <div>${state.customer.city}, ${state.customer.state} ${state.customer.zip}</div>
        </div>
        <table style="width:100%; border-collapse:collapse; margin-bottom:12px; font-size:0.85em;">
            ${items.map(item => `<tr><td style="padding:6px 0; border-bottom:1px solid #eee;">${item.name} (x${item.qty})</td><td style="text-align:right; font-weight:bold;">$${(item.price * item.qty).toFixed(2)}</td></tr>`).join("")}
        </table>
        <div class="summary-area">
            <div class="summary-row"><div class="summary-label">Subtotal:</div><div class="summary-val">$${subtotal.toFixed(2)}</div></div>
            ${discount > 0 ? `<div class="summary-row" style="color:#2ecc71;"><div class="summary-label">10% Bulk Discount:</div><div class="summary-val">-$${discount.toFixed(2)}</div></div>` : ''}
            ${tax > 0 ? `<div class="summary-row"><div class="summary-label">Sales Tax (6%):</div><div class="summary-val">$${tax.toFixed(2)}</div></div>` : ''}
            ${kegDeposit > 0 ? `<div class="summary-row"><div class="summary-label">Keg Deposits:</div><div class="summary-val">$${kegDeposit.toFixed(2)}</div></div>` : ''}
            <div class="summary-row grand-total"><div class="summary-label">Total:</div><div class="summary-val">$${grandTotal.toFixed(2)}</div></div>
        </div>
        <div id="post-order-actions" style="margin-top:20px; border-top:1px solid #ddd; padding-top:15px;">
            <label style="display:flex; align-items:center; gap:8px; margin-bottom:10px; font-size:0.85em; cursor:pointer;">
                <input type="checkbox" id="send-email-cb" onchange="toggleEmailInput(this.checked)"> Email receipt
            </label>
            <input type="email" id="client-email" placeholder="Email address" style="display:none; width:100%; padding:8px; margin-bottom:15px; border:1px solid #ccc; border-radius:4px; font-size:0.9em;">
            <button class="success" onclick="submitOrder()">Submit Final Order</button>
            <button class="secondary" onclick="window.print()">Print Receipt</button>
            <button class="secondary" style="background:#fff; border:1px solid #ccc;" onclick="state.step=2;render()">← Back</button>
        </div>
      </div>`;
    }
    else if (state.step === 4) {
        app.innerHTML = `<div class="card" style="text-align:center; padding:40px 20px;">
            <h2 style="color:#28a745;">Order Submitted!</h2>
            <button class="primary" onclick="location.reload()" style="max-width:200px; margin-top:20px;">New Order</button>
        </div>`;
    }
  }

  function toggleEmailInput(show) {
    document.getElementById('client-email').style.display = show ? 'block' : 'none';
  }

  function updateCart(idx, qty) {
    const p = products[idx];
    const q = Math.max(0, parseInt(qty) || 0);
    let item = state.cart.find(i => i.name === p.name);
    if (item) item.qty = q; else state.cart.push({...p, qty: q});
    updateLiveDisplay();
  }

  function updateLiveDisplay() {
    const subtotal = state.cart.reduce((s, i) => s + (i.price * i.qty), 0);
    const totalQty = state.cart.reduce((s, i) => s + i.qty, 0);
    const discount = totalQty >= 10 ? subtotal * 0.10 : 0;
    const taxableAmount = subtotal - discount;
    const taxRate = (state.customer && checkIsRestaurant(state.customer.name)) ? 0.06 : 0;
    const tax = taxableAmount * taxRate;
    document.getElementById("live-total").innerText = "$" + (taxableAmount + tax).toFixed(2);
    document.getElementById("savings-label").innerText = discount > 0 ? "10% BULK DISCOUNT APPLIED" : "";
    document.getElementById("tax-label").innerText = tax > 0 ? "+6% Sales Tax included" : "";
  }

  async function doSearch(val) {
    const box = document.getElementById("results");
    if (val.length < 2) { box.style.display="none"; return; }
    try {
        const res = await fetch(`${API_URL}?q=${encodeURIComponent(val)}`);
        const data = await res.json();
        box.style.display = "block";
        box.innerHTML = data.results.map(c => `<div class="dropdown-item" onmousedown='setCustomer(${JSON.stringify(c).replace(/'/g, "&apos;")})'>${c.name}</div>`).join("");
    } catch(e) { console.error("Search error", e); }
  }

  function setCustomer(c) { state.customer = c; state.step = 2; render(); }
  function getQty(name) { let i = state.cart.find(c => c.name === name); return i ? i.qty : 0; }

  async function submitOrder() {
    const btn = document.querySelector(".success");
    const sendEmail = document.getElementById('send-email-cb').checked;
    const clientEmail = document.getElementById('client-email').value;
    if (sendEmail && !clientEmail) { alert("Please enter an email address."); return; }
    btn.innerText = "Processing..."; btn.disabled = true;
    const payload = {
      customer: state.customer,
      items: state.cart.filter(i => i.qty > 0),
      sendEmail: sendEmail,
      clientEmail: clientEmail
    };
    try {
      const res = await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) });
      const result = await res.json();
      if(result.success) { state.step = 4; render(); }
    } catch(e) { alert("Error: " + e.message); btn.disabled = false; btn.innerText = "Submit Final Order"; }
  }
  init();
</script>
</body>
</html>
