<script>
    // ... [KEEP init, render, login, addToCart functions the same] ...

    // UPDATED: This function now packages the math specifically for the PDF generator
    async function submitFinalOrder() {
        if (!state.customer.email || state.customer.email.trim() === "" || state.customer.email === "undefined") {
            const userEmail = prompt("Please enter your email address for order confirmation:");
            if (!userEmail || !userEmail.includes("@")) {
                alert("A valid email address is required.");
                return;
            }
            state.customer.email = userEmail.trim();
        }

        const btn = document.querySelector('.btn-success');
        btn.disabled = true;
        btn.innerText = "GENERATING PDF & SUBMITTING...";

        // Calculate final math to send to the Script
        let subtotal = 0, kegCount = 0, caseCount = 0;
        for (const key in state.cart) {
            const item = state.cart[key];
            subtotal += (item.price * item.qty);
            if (item.type.toLowerCase().includes("keg") || item.type.includes("1/")) kegCount += item.qty;
            if (item.type.toLowerCase().includes("case")) caseCount += item.qty;
        }
        
        const restKeywords = ["RESTAURANT", "BAR", "GRILL", "PUB", "TAVERN", "INN", "DINER", "KITCHEN", "HOUSE", "BREWERY", "BISTRO", "CAFE", "CLUB", "PIZZA", "STEAK", "DELI"];
        const isRestaurant = state.customer.name.toUpperCase().split(" ").some(word => restKeywords.includes(word));
        
        const tax = isRestaurant ? (subtotal * 0.06) : 0;
        const discount = (caseCount >= 10) ? (subtotal * 0.10) : 0;
        const deposits = (kegCount * 30);
        const grandTotal = state.manualTotal !== null ? state.manualTotal : (subtotal + tax + deposits - discount);

        // Package data for the Google Script PDF Generator
        const payload = {
            ...state,
            summary: {
                subtotal: subtotal.toFixed(2),
                tax: tax.toFixed(2),
                discount: discount.toFixed(2),
                deposits: deposits.toFixed(2),
                grandTotal: grandTotal.toFixed(2),
                orderDate: new Date().toLocaleDateString()
            }
        };

        try {
            await fetch(API_URL, { 
                method: "POST", 
                mode: "no-cors", 
                body: JSON.stringify(payload) 
            });
            alert("Order Submitted! A PDF invoice has been sent to " + state.customer.email);
            location.reload();
        } catch (e) {
            alert("Error submitting order.");
            btn.disabled = false;
            btn.innerText = "Submit Final Order";
        }
    }

    // Re-use the same logic for the Email Copy button
    async function sendEmailCopy() {
        submitFinalOrder(); // This now handles both since the logic is identical
    }

    init();
</script>
