<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBC Wholesale Portal</title>
    <style>
        :root { --sbc-blue: #007bff; --sbc-dark: #1a1a1a; --bg: #f4f7f9; --red: #d9534f; }
        body { font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; background: var(--bg); margin: 0; padding-bottom: 120px; color: #333; }
        
        /* HEADER STYLES */
        .site-header { background: #fff; padding: 30px 5%; border-bottom: 5px solid var(--sbc-dark); display: flex; align-items: center; gap: 25px; }
        .site-header img { height: 85px; }
        .header-text { text-align: left; }
        .site-header h1 { margin: 0; font-size: 1.8em; text-transform: uppercase; }

        .container { max-width: 900px; margin: 40px auto; padding: 0 20px; }
        .card { background: white; padding: 40px; border-radius: 4px; border: 1px solid #e1e4e8; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        
        /* LEGAL SCROLL */
        .legal-scroll { height: 350px; overflow-y: scroll; border: 1px solid #eee; padding: 25px; background: #fafafa; font-size: 0.9em; line-height: 1.7; margin: 20px 0; border-radius: 4px; text-align: left; }
        
        /* STOCK INDICATORS */
        .stock-badge { font-size: 0.75em; font-weight: bold; padding: 4px 8px; border-radius: 3px; display: inline-block; margin-top: 5px; }
        .low-stock { background: #fff1f0; color: var(--red); border: 1px solid var(--red); }
        .out-of-stock { background: #eee; color: #777; border: 1px solid #ccc; }
        .in-stock { color: #28a745; border: 1px solid #28a745; background: #f6ffed; }

        /* LIVE BAR */
        .live-bar { position: fixed; bottom: 0; left: 0; right: 0; background: var(--sbc-dark); color: white; padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; z-index: 9999; border-top: 4px solid var(--sbc-blue); }
        .summary-item span { font-size: 1.2em; font-weight: bold; }

        /* BUTTONS */
        .btn { padding: 12px 25px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; text-transform: uppercase; transition: 0.2s; }
        .btn-primary { background: var(--sbc-blue); color: white; }
        .btn-success { background: #28a745; color: white; width: 100%; margin-top: 20px; font-size: 1.2em; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-outline { background: transparent; border: 1px solid #ccc; color: #333; }
        
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-top: 30px; }
        .product-card { border: 1px solid #eee; padding: 20px; text-align: center; border-radius: 4px; }
        .qty-input { width: 60px; padding: 8px; text-align: center; font-weight: bold; border: 1px solid #ccc; }
        .qty-input.error { border: 2px solid var(--red); background: #fff1f0; }

        .review-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .review-table th { text-align: left; padding: 12px; border-bottom: 2px solid #333; font-size: 0.85em; color: #666; }
        .review-table td { padding: 12px; border-bottom: 1px solid #eee; }

        .action-flex { display: flex; gap: 10px; margin-top: 20px; }

        @media print {
            .live-bar, .btn, .btn-success, .action-flex { display: none !important; }
            body { background: white; padding: 0; }
            .card { border: none; box-shadow: none; padding: 0; }
        }
    </style>
</head>
<body>

<header class="site-header" id="main-header">
    <img src="https://raw.githubusercontent.com/remyjdavis/brewery-order-form/main/logo.png" alt="SBC Logo">
    <div class="header-text">
        <h1>Suburban Brewing Co.</h1>
        <p>3041 Horseshoe Pike, Honey Brook, PA 19344<br>
        <strong>Sales Rep: Remy Davis</strong><br>
        (908) 642-1019 | remyjdavis90@gmail.com</p>
    </div>
</header>

<div class="container" id="app"></div>

<div id="live-bar" class="live-bar" style="display:none;">
    <div id="stock-error" style="color:var(--red); font-weight:bold; display:none;">⚠️ QUANTITY EXCEEDS STOCK</div>
    <div class="summary-flex" style="display:flex; gap:30px;">
        <div class="summary-item"><small>Running Total</small><span id="live-total" style="color:var(--sbc-blue);">$0.00</span></div>
    </div>
    <button class="btn btn-primary" id="review-btn" onclick="goToReview()">Review Order</button>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyT1PzljxVZ9NKBbgmAJ7kgPul228vnwrdjf_YRbzhIMR_rXhG2tx36-yzBHfFNH5DX/exec";
    const PRODUCT_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTOYHzF6u43ORNewiUMe-i-FtSGPB4mHw-BN9xlqY-UzHvRWUVr-Cgro_kqiGm4G-fKAA6w3ErQwp3O/pub?gid=1782602603&output=csv";

    let products = [];
    let state = { step: 0, customer: null, cart: [] };

    async function init() {
        const res = await fetch(PRODUCT_CSV);
        const text = await res.text();
        const rows = text.split("\n");
        const headers = rows[0].split(",");
        const stockIndex = headers.findIndex(h => h.trim() === "Qty In Stock");

        products = rows.slice(1).map(r => {
            const c = r.split(",");
            return { 
                name: c[0]?.trim(), 
                price: parseFloat(c[1]) || 0, 
                stock: stockIndex !== -1 ? (parseInt(c[stockIndex]) || 0) : 999 
            };
        }).filter(p => p.name);
        render();
    }

    function calculate() {
        let sub = 0, totalQty = 0, dep = 0, overStock = false;
        state.cart.forEach(i => {
            if (i.qty > 0) {
                sub += (i.price * i.qty);
                totalQty += i.qty;
                if (i.name.toLowerCase().includes("keg")) dep += (i.qty * 30);
                if (i.qty > i.max) overStock = true;
            }
        });
        const disc = (totalQty >= 10) ? (sub * 0.10) : 0;
        const keywords = ["restaurant", "cafe", "grill", "pub", "kitchen", "bar", "tavern", "inn", "bistro", "diner", "steakhouse", "eatery", "pizzeria", "pizza", "deli", "brewpub", "lounge", "house", "brasserie", "cantina", "shack", "gastropub", "smokehouse", "bbq", "oyster", "sushi", "trattoria", "noodle", "burger", "wing", "taproom"];
        const isRestaurant = state.customer && keywords.some(kw => state.customer.name.toLowerCase().includes(kw));
        const tax = isRestaurant ? ((sub - disc) * 0.06) : 0;
        return { sub, disc, dep, tax, final: (sub - disc + dep + tax), overStock };
    }

    function render() {
        const app = document.getElementById("app");
        const bar = document.getElementById("live-bar");
        const header = document.getElementById("main-header");
        app.innerHTML = "";
        bar.style.display = (state.step === 2) ? "flex" : "none";
        header.style.display = (state.step === 3) ? "none" : "flex";

        if (state.step === 0) {
            app.innerHTML = `
                <div class="card">
                    <h2 style="margin-top:0; text-align:center;">Wholesale Terms of Sale</h2>
                    <div class="legal-scroll">
                        <p><strong>1. QUALITY CONTROL:</strong> All Suburban Brewing Co. products are unpasteurized and must be maintained at a constant refrigeration temperature of 38°F. Suburban Brewing Co. is not liable for product spoilage due to temperature abuse at the retail level.</p>
                        <p><strong>2. LICENSURE:</strong> Purchaser warrants that they hold a valid retail liquor license. Any change in licensure status must be reported to Suburban Brewing Co. immediately.</p>
                        <p><strong>3. PAYMENTS:</strong> Payment is Net-on-Delivery. Fintech accounts are drafted automatically. Non-fintech accounts must provide a business check at the time of delivery.</p>
                        <p><strong>4. COOPERAGE:</strong> All kegs remain the property of Suburban Brewing Co. A $30.00 deposit is required for each unit. Lost or damaged kegs will be billed at $120.00 per unit.</p>
                        <p><strong>5. TAXATION & DISCOUNTS:</strong> A 6% PA Sales Tax is applied only to restaurant accounts. A 10% volume discount is applied to orders of 10 units or more.</p>
                        <p><strong>6. ACCEPTANCE:</strong> By proceeding with this order, the purchaser agrees to all terms and conditions stated above.</p>
                    </div>
                    <label style="display:block; margin-bottom:20px; cursor:pointer; text-align:center;">
                        <input type="checkbox" id="agree"> I agree to the Suburban Brewing Co. Wholesale Terms.
                    </label>
                    <button class="btn btn-primary" style="width:100%" onclick="if(document.getElementById('agree').checked){state.step=1;render()}">Accept & Enter Portal</button>
                </div>`;
        } else if (state.step === 1) {
            app.innerHTML = `<div class="card"><h2>Account Search</h2><input type="text" placeholder="Search business name..." oninput="doSearch(this.value)"><div id="results"></div></div>`;
        } else if (state.step === 2) {
            app.innerHTML = `
                <div class="card">
                    <h3>Ordering for: ${state.customer.name}</h3>
                    <div class="product-grid">${products.map(p => {
                        const isOut = p.stock <= 0;
                        return `
                        <div class="product-card">
                            <strong>${p.name}</strong><br>$${p.price.toFixed(2)}<br>
                            <span class="stock-badge ${isOut ? 'out-of-stock' : (p.stock <= 5 ? 'low-stock' : 'in-stock')}">
                                ${isOut ? 'SOLD OUT' : (p.stock <= 5 ? 'LOW STOCK: ' + p.stock : p.stock + ' IN STOCK')}
                            </span><br><br>
                            <input type="number" class="qty-input ${getQty(p.name) > p.stock ? 'error' : ''}" 
                                min="0" max="${p.stock}" ${isOut ? 'disabled' : ''} value="${getQty(p.name)}" 
                                oninput="updateCart('${p.name}', ${p.price}, this.value, ${p.stock})">
                        </div>`;
                    }).join("")}</div>
                </div>`;
            updateBar();
        } else if (state.step === 3) {
            const t = calculate();
            const items = state.cart.filter(i => i.qty > 0);
            app.innerHTML = `
                <div class="card">
                    <div style="border-bottom:4px solid #1a1a1a; padding-bottom:20px; margin-bottom:30px; display:flex; align-items:center; gap:20px;">
                        <img src="https://raw.githubusercontent.com/remyjdavis/brewery-order-form/main/logo.png" style="height:70px;">
                        <div><strong>Suburban Brewing Co.</strong><br>3041 Horseshoe Pike, Honey Brook, PA 19344<br><strong>Sales Rep: Remy Davis</strong> | (908) 642-1019</div>
                    </div>
                    <div style="display:flex; justify-content:space-between;">
                        <div><strong>BILL TO:</strong><br>${state.customer.name}<br>${state.customer.address}<br>${state.customer.city}, ${state.customer.state} ${state.customer.zip}</div>
                        <div style="text-align:right;"><strong>ORDER DATE:</strong><br>${new Date().toLocaleDateString()}</div>
                    </div>
                    <table class="review-table">
                        <thead><tr><th>Product</th><th>Qty</th><th>Price</th><th>Total</th></tr></thead>
                        <tbody>${items.map(i => `<tr><td>${i.name}</td><td>${i.qty}</td><td>$${i.price.toFixed(2)}</td><td>$${(i.price*i.qty).toFixed(2)}</td></tr>`).join("")}</tbody>
                    </table>
                    <div style="text-align:right; margin-top:20px; line-height:1.8;">
                        Subtotal: $${t.sub.toFixed(2)}<br>
                        ${t.disc > 0 ? `<span style="color:var(--red)">10% Vol. Discount: -$${t.disc.toFixed(2)}</span><br>` : ''}
                        PA Sales Tax (6%): $${t.tax.toFixed(2)}<br>
                        <strong>Keg Deposits ($30/ea): $${t.dep.toFixed(2)}</strong><br>
                        <strong style="font-size:1.6em; color:var(--sbc-blue); display:block; margin-top:10px;">Order Total: $${t.final.toFixed(2)}</strong>
                    </div>
                    
                    <div class="action-flex">
                        <button class="btn btn-secondary" style="flex:1;" onclick="state.step=2;render()">← Back to Shop</button>
                        <button class="btn btn-outline" style="flex:1;" onclick="window.print()">Print Summary</button>
                        <button class="btn btn-outline" style="flex:1;" onclick="emailOrder()">Email Order</button>
                    </div>
                    <button class="btn btn-success" onclick="submitOrder()">Submit Final Order</button>
                </div>`;
        }
    }

    function updateCart(name, price, qty, max) {
        const idx = state.cart.findIndex(i => i.name === name);
        const q = Math.max(0, parseInt(qty) || 0);
        if (idx > -1) state.cart[idx].qty = q;
        else state.cart.push({name, price, qty: q, max});
        updateBar();
    }

    function updateBar() {
        const t = calculate();
        document.getElementById("live-total").innerText = "$" + t.final.toFixed(2);
        const err = document.getElementById("stock-error");
        const btn = document.getElementById("review-btn");
        if (t.overStock) { err.style.display = "block"; btn.disabled = true; btn.style.opacity = "0.5"; }
        else { err.style.display = "none"; btn.disabled = false; btn.style.opacity = "1"; }
    }

    function goToReview() { if (!calculate().overStock) { state.step = 3; render(); } }

    async function doSearch(val) {
        if (val.length < 2) return;
        const res = await fetch(`${API_URL}?q=${encodeURIComponent(val)}`);
        const data = await res.json();
        document.getElementById("results").innerHTML = data.results.map(c => `<div style="padding:15px; border-bottom:1px solid #eee; cursor:pointer;" onclick='selectCust(${JSON.stringify(c).replace(/'/g, "&apos;")})'><strong>${c.name}</strong><br><small>${c.address}</small></div>`).join("");
    }

    window.selectCust = (c) => { state.customer = c; state.step = 2; render(); };
    function getQty(name) { return state.cart.find(c => c.name === name)?.qty || 0; }

    function emailOrder() {
        const t = calculate();
        const items = state.cart.filter(i => i.qty > 0).map(i => `${i.name} (Qty: ${i.qty})`).join('%0A');
        const body = `Order Details for ${state.customer.name}%0A%0AItems:%0A${items}%0A%0AOrder Total: $${t.final.toFixed(2)}`;
        window.location.href = `mailto:?subject=SBC Order - ${state.customer.name}&body=${body}`;
    }

    async function submitOrder() {
        if (calculate().overStock) return alert("Error: Order exceeds current stock.");
        await fetch(API_URL, { method: "POST", body: JSON.stringify({ ...state, totals: calculate() }) });
        alert("Order Submitted Successfully!");
        location.reload();
    }
    init();
</script>
</body>
</html>
