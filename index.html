<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBC Wholesale Portal</title>
    <style>
        :root { --sbc-blue: #007bff; --sbc-dark: #1a1a1a; --bg: #f8f9fa; --border: #dee2e6; --text: #2d3436; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); margin: 0; color: var(--text); padding-bottom: 80px; }
        .site-header { background: #fff; padding: 1rem 5%; border-bottom: 3px solid var(--sbc-dark); display: flex; align-items: center; justify-content: space-between; }
        .site-header img { height: 55px; }
        .container { max-width: 1000px; margin: 30px auto; padding: 0 20px; }
        .card { background: white; padding: 2rem; border-radius: 10px; border: 1px solid var(--border); box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .legal-scroll { height: 350px; overflow-y: auto; border: 1px solid #333; padding: 1.5rem; margin: 1rem 0; font-size: 0.85rem; background: #fff; }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; margin-top: 1.5rem; }
        .product-card { background: #fff; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; text-align: center; }
        .product-img { width: 100%; height: 180px; object-fit: cover; background: #eee; }
        .product-info { padding: 1.2rem; }
        .live-bar { position: fixed; bottom: 0; left: 0; right: 0; background: var(--sbc-dark); color: white; padding: 1rem 8%; display: flex; justify-content: space-between; align-items: center; z-index: 1001; }
        .btn { padding: 12px 24px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; text-transform: uppercase; }
        .btn-primary { background: var(--sbc-blue); color: white; }
        .review-table { width: 100%; border-collapse: collapse; margin-top: 1.5rem; }
        .review-table th, .review-table td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        #login-err { color: #d63031; font-weight: bold; margin-bottom: 15px; display: none; }
        @media print { .no-print, .live-bar { display: none !important; } .card { border: none; box-shadow: none; } }
    </style>
</head>
<body>

<header class="site-header">
    <div style="display:flex; align-items:center; gap:15px;">
        <img src="https://raw.githubusercontent.com/remyjdavis/brewery-order-form/main/logo.png" alt="SBC Logo">
        <h2 style="margin:0;">Suburban Brewing Co.</h2>
    </div>
    <div style="text-align:right; font-size:0.85rem;">
        3041 Horseshoe Pike, Honey Brook, PA<br>
        <strong>Remy Davis: (908) 642-1019</strong>
    </div>
</header>

<div class="container" id="app"></div>

<div id="live-bar" class="live-bar" style="display:none;">
    <div>TOTAL: <span id="live-total" style="color:var(--sbc-blue); font-weight:800; font-size:1.3rem;">$0.00</span></div>
    <button class="btn btn-primary" onclick="state.step=3;render()">Review Order</button>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyT1PzljxVZ9NKBbgmAJ7kgPul228vnwrdjf_YRbzhIMR_rXhG2tx36-yzBHfFNH5DX/exec";
    const PRODUCT_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTOYHzF6u43ORNewiUMe-i-FtSGPB4mHw-BN9xlqY-UzHvRWUVr-Cgro_kqiGm4G-fKAA6w3ErQwp3O/pub?gid=1782602603&output=csv";

    let groupedProducts = {};
    let state = { step: 0, customer: null, cart: {} };

    async function init() {
        try {
            const res = await fetch(PRODUCT_CSV);
            const text = await res.text();
            const rows = text.split("\n").slice(1);
            rows.forEach(r => {
                const c = r.split(",");
                if (!c[0]) return;
                const cleanName = c[0].replace(/(Keg|Case|1\/2|1\/6|BBL|Can)/gi, '').trim();
                if (!groupedProducts[cleanName]) groupedProducts[cleanName] = { name: cleanName, img: c[3] || '', options: [] };
                groupedProducts[cleanName].options.push({ type: c[0].replace(cleanName, '').trim() || "Unit", price: parseFloat(c[1]) || 0, stock: parseInt(c[2]) || 0 });
            });
            render();
        } catch (e) { console.error("Load Error", e); }
    }

    async function attemptLogin() {
        const key = document.getElementById("loginInput").value.trim().toUpperCase();
        if (key.length < 4) return;
        const btn = document.getElementById("loginBtn");
        btn.innerText = "Verifying...";
        
        try {
            const res = await fetch(`${API_URL}?key=${encodeURIComponent(key)}`);
            const data = await res.json();
            if (data.success) {
                state.customer = data.customer;
                state.step = 2;
                render();
            } else {
                document.getElementById("login-err").style.display = "block";
                btn.innerText = "Login";
            }
        } catch (e) { alert("Connection Error"); btn.innerText = "Login"; }
    }

    function updateCart(beer, selectId, qtyId) {
        const opt = groupedProducts[beer].options[document.getElementById(selectId).value];
        const qty = parseInt(document.getElementById(qtyId).value) || 0;
        if (qty > 0) state.cart[`${beer}-${opt.type}`] = { beer, type: opt.type, price: opt.price, qty };
        else delete state.cart[`${beer}-${opt.type}`];
        
        let total = 0;
        Object.values(state.cart).forEach(i => total += (i.price * i.qty));
        document.getElementById("live-total").innerText = "$" + total.toFixed(2);
    }

    function render() {
        const app = document.getElementById("app");
        document.getElementById("live-bar").style.display = (state.step === 2) ? "flex" : "none";

        if (state.step === 0) {
            app.innerHTML = `<div class="card"><h2 style="text-align:center;">Wholesale Agreement</h2><div class="legal-scroll"><p>Cold Storage Required (34-38F). Keg Deposits are $30. Payment due at delivery for Check customers.</p></div><button class="btn btn-primary" style="width:100%;" onclick="state.step=1;render()">I Accept Agreement</button></div>`;
        } else if (state.step === 1) {
            app.innerHTML = `<div class="card" style="max-width:400px; margin:auto; text-align:center;"><h3>Client Login</h3><p style="font-size:0.8rem; color:#666;">Enter your Login Key to proceed</p><input type="text" id="loginInput" placeholder="EX: REMY12345" style="width:100%; padding:15px; margin-bottom:10px; border:2px solid var(--sbc-dark); border-radius:8px; text-align:center; font-size:1.2rem; text-transform:uppercase;"><div id="login-err">⚠️ Invalid Login Key</div><button id="loginBtn" class="btn btn-primary" style="width:100%;" onclick="attemptLogin()">Login</button></div>`;
        } else if (state.step === 2) {
            app.innerHTML = `<h3>Welcome, ${state.customer.name}</h3><div class="product-grid">${Object.values(groupedProducts).map(p => {
                const id = p.name.replace(/\s/g,'');
                return `<div class="product-card"><img src="${p.img}" class="product-img" onerror="this.src='https://via.placeholder.com/200?text=SBC'"><div class="product-info"><h4>${p.name}</h4><select id="s-${id}" style="width:100%; padding:5px;" onchange="updateCart('${p.name}','s-${id}','q-${id}')">${p.options.map((o,i)=>`<option value="${i}">${o.type} - $${o.price}</option>`).join('')}</select><br><br>Qty: <input type="number" id="q-${id}" style="width:60px;" oninput="updateCart('${p.name}','s-${id}','q-${id}')"></div></div>`;
            }).join('')}</div>`;
        } else if (state.step === 3) {
            let sub = 0; Object.values(state.cart).forEach(i => sub += (i.price * i.qty));
            app.innerHTML = `<div class="card">
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <div><strong>Suburban Brewing Co.</strong><br>3041 Horseshoe Pike<br>Honey Brook, PA 19344</div>
                    <div style="text-align:right;"><strong>Order Date:</strong><br>${new Date().toLocaleDateString()}</div>
                </div>
                <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">
                <div style="margin-bottom:20px;">
                    <strong style="font-size:1.2rem; color:var(--sbc-blue);">${state.customer.name}</strong><br>
                    ${state.customer.address}<br>
                    ${state.customer.city}, ${state.customer.state} ${state.customer.zip}
                </div>
                <table class="review-table"><thead><tr><th>Product</th><th>Qty</th><th>Total</th></tr></thead><tbody>
                ${Object.values(state.cart).map(i=>`<tr><td>${i.beer} (${i.type})</td><td>${i.qty}</td><td>$${(i.qty*i.price).toFixed(2)}</td></tr>`).join('')}
                </tbody></table>
                <div style="text-align:right; margin-top:20px; font-size:1.5rem;"><strong>TOTAL: $${sub.toFixed(2)}</strong></div>
                <div class="no-print" style="margin-top:30px; display:flex; gap:10px;">
                    <button class="btn" style="flex:1; border:1px solid #ccc;" onclick="state.step=2;render()">Edit Order</button>
                    <button class="btn btn-primary" style="flex:2; background:#00b894;" onclick="submitOrder()">Submit Final Order</button>
                </div>
            </div>`;
        }
    }

    async function submitOrder() {
        const btn = event.target; btn.disabled = true; btn.innerText = "Processing...";
        await fetch(API_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(state) });
        alert("Order Received!"); location.reload();
    }

    init();
</script>
</body>
</html>
