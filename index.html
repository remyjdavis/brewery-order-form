<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBC Wholesale Portal</title>
    <style>
        :root { 
            --sbc-blue: #007bff; 
            --sbc-dark: #1a1a1a; 
            --bg: #f8f9fa; 
            --border: #dee2e6;
            --text-main: #2d3436;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg); 
            margin: 0; 
            color: var(--text-main);
            line-height: 1.5;
        }
        
        /* Professional Header */
        .site-header { 
            background: #fff; 
            padding: 2rem 5%; 
            border-bottom: 4px solid var(--sbc-dark); 
            display: flex; 
            align-items: center; 
            gap: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .site-header img { height: 90px; }
        .header-text h1 { margin: 0; font-size: 1.8rem; letter-spacing: -0.5px; }
        .header-text p { margin: 5px 0 0; font-size: 0.9rem; color: #636e72; }
        
        .container { max-width: 1100px; margin: 40px auto; padding: 0 20px; }
        
        /* Modern Cards */
        .card { 
            background: white; 
            padding: 2.5rem; 
            border-radius: 12px; 
            border: 1px solid var(--border); 
            box-shadow: 0 10px 30px rgba(0,0,0,0.04); 
        }

        .legal-scroll { 
            height: 400px; 
            overflow-y: auto; 
            border: 1px solid #eee; 
            padding: 2rem; 
            background: #fdfdfd; 
            font-size: 0.9rem; 
            border-radius: 8px;
            margin: 1.5rem 0;
        }

        /* Product Grid Design */
        .product-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 2rem; 
            margin-top: 2rem; 
        }
        .product-card { 
            background: #fff;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border);
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
        }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 12px 20px rgba(0,0,0,0.08); }
        .product-img { width: 100%; height: 220px; object-fit: cover; background: #eee; }
        
        .product-info { padding: 1.5rem; flex-grow: 1; text-align: left; }
        .product-info h3 { margin: 0 0 1rem 0; font-size: 1.25rem; border-bottom: 2px solid var(--bg); padding-bottom: 10px; }
        
        .format-label { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #b2bec3; margin-bottom: 5px; display: block; }
        .type-select { 
            width: 100%; 
            padding: 12px; 
            border-radius: 6px; 
            border: 1px solid var(--border); 
            background: #fff;
            font-size: 0.95rem;
            margin-bottom: 1rem;
        }

        .qty-container { display: flex; align-items: center; gap: 10px; justify-content: space-between; }
        .qty-input { 
            width: 80px; 
            padding: 10px; 
            text-align: center; 
            font-weight: 700; 
            border: 2px solid var(--border); 
            border-radius: 6px;
        }

        /* Status Bar */
        .live-bar { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: var(--sbc-dark); color: white; 
            padding: 1.2rem 10%; 
            display: flex; justify-content: space-between; align-items: center; 
            z-index: 999; border-top: 4px solid var(--sbc-blue);
        }

        .btn { 
            padding: 12px 28px; border: none; border-radius: 6px; 
            font-weight: 700; cursor: pointer; text-transform: uppercase; 
            transition: all 0.2s; font-size: 0.9rem;
        }
        .btn-primary { background: var(--sbc-blue); color: white; }
        .btn-success { background: #00b894; color: white; width: 100%; margin-top: 2rem; }
        .btn-outline { background: transparent; border: 1px solid #dfe6e9; color: var(--text-main); }

        .review-table { width: 100%; border-collapse: collapse; margin: 2rem 0; }
        .review-table th { text-align: left; padding: 15px; background: var(--bg); border-bottom: 2px solid var(--sbc-dark); }
        .review-table td { padding: 15px; border-bottom: 1px solid #eee; }

        @media print {
            .live-bar, .btn, .action-flex { display: none !important; }
            .card { border: none; box-shadow: none; padding: 0; }
        }
    </style>
</head>
<body>

<header class="site-header" id="main-header">
    <img src="https://raw.githubusercontent.com/remyjdavis/brewery-order-form/main/logo.png" alt="SBC Logo">
    <div class="header-text">
        <h1>Suburban Brewing Co.</h1>
        <p>3041 Horseshoe Pike, Honey Brook, PA 19344 | <strong>Remy Davis: (908) 642-1019</strong></p>
    </div>
</header>

<div class="container" id="app"></div>

<div id="live-bar" class="live-bar" style="display:none;">
    <div id="stock-error" style="color:#ff7675; font-weight:bold; display:none;">⚠️ OVER STOCK LIMIT</div>
    <div class="summary-item">ORDER TOTAL: <span id="live-total" style="color:var(--sbc-blue); font-size: 1.5rem; margin-left:10px;">$0.00</span></div>
    <button class="btn btn-primary" id="review-btn" onclick="goToReview()">Review & Confirm</button>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyT1PzljxVZ9NKBbgmAJ7kgPul228vnwrdjf_YRbzhIMR_rXhG2tx36-yzBHfFNH5DX/exec";
    const PRODUCT_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTOYHzF6u43ORNewiUMe-i-FtSGPB4mHw-BN9xlqY-UzHvRWUVr-Cgro_kqiGm4G-fKAA6w3ErQwp3O/pub?gid=1782602603&output=csv";

    let groupedProducts = {};
    let state = { step: 0, customer: null, cart: {}, overrideActive: false, emailRequested: false };

    async function init() {
        try {
            const res = await fetch(PRODUCT_CSV);
            const text = await res.text();
            const rows = text.split("\n").slice(1);
            
            rows.forEach(r => {
                const c = r.split(",");
                const fullName = c[0]?.trim();
                if (!fullName) return;
                
                // Extract clean name (removes "Keg", "Case", etc for the heading)
                const cleanName = fullName.replace(/(Keg|Case|1\/2|1\/6|BBL|Can)/gi, '').trim();
                const formatType = fullName.replace(cleanName, '').trim() || "Unit";
                
                if (!groupedProducts[cleanName]) {
                    groupedProducts[cleanName] = { 
                        name: cleanName, 
                        img: c[3]?.trim() || '', 
                        options: [] 
                    };
                }
                groupedProducts[cleanName].options.push({
                    type: formatType,
                    price: parseFloat(c[1]) || 0,
                    stock: parseInt(c[2]) || 0
                });
            });
            render();
        } catch (e) { console.error("Load Error", e); }
    }

    function calculate() {
        let sub = 0, totalQty = 0, dep = 0, overStock = false;
        Object.values(state.cart).forEach(item => {
            if (item.qty > 0) {
                sub += (item.price * item.qty);
                totalQty += item.qty;
                if (/BBL|Keg/i.test(item.type)) dep += (item.qty * 30);
                if (!state.overrideActive && item.qty > item.max) overStock = true;
            }
        });
        const disc = (totalQty >= 10) ? (sub * 0.10) : 0;
        const tax = (state.customer && /restaurant|bar|pub|grill|cafe/i.test(state.customer.name)) ? ((sub - disc) * 0.06) : 0;
        return { sub, disc, dep, tax, final: (sub - disc + dep + tax), overStock };
    }

    function updateCart(beerName, selectId, qtyId) {
        const select = document.getElementById(selectId);
        const qtyInput = document.getElementById(qtyId);
        const optIndex = select.value;
        const option = groupedProducts[beerName].options[optIndex];
        const key = `${beerName}-${option.type}`;
        const qty = Math.max(0, parseInt(qtyInput.value) || 0);

        if (qty > 0) {
            state.cart[key] = { beer: beerName, type: option.type, price: option.price, qty: qty, max: option.stock };
        } else {
            delete state.cart[key];
        }
        updateBar();
    }

    function render() {
        const app = document.getElementById("app");
        const bar = document.getElementById("live-bar");
        app.innerHTML = "";
        bar.style.display = (state.step === 2) ? "flex" : "none";

        if (state.step === 0) {
            app.innerHTML = `
                <div class="card" style="max-width:800px; margin:auto;">
                    <h2 style="text-align:center;">Wholesale Agreement</h2>
                    <div class="legal-scroll">
                        <h4>1. Product Quality</h4><p>Must be maintained at 38°F. All sales are final.</p>
                        <h4>2. Payment</h4><p>Check due at delivery or processed via Fintech.</p>
                        <h4>3. Cooperage</h4><p>$30 deposit per keg shell. SBC retains ownership.</p>
                        <h4>4. Compliance</h4><p>Purchaser warrants valid PA Liquor Licensure.</p>
                    </div>
                    <label style="display:block; text-align:center; margin: 2rem 0;">
                        <input type="checkbox" id="agree"> I have read and agree to the Master Wholesale Terms.
                    </label>
                    <button class="btn btn-primary" style="width:100%" onclick="if(document.getElementById('agree').checked){state.step=1;render()}">Enter Portal</button>
                </div>`;
        } else if (state.step === 1) {
            app.innerHTML = `<div class="card" style="max-width:600px; margin:auto; text-align:center;">
                <h2>Search Account</h2>
                <input type="text" placeholder="Start typing business name..." oninput="doSearch(this.value)" 
                style="width:100%; padding:15px; border:1px solid var(--border); border-radius:8px; font-size:1.1rem; box-sizing:border-box;">
                <div id="results" style="margin-top:20px; text-align:left;"></div>
            </div>`;
        } else if (state.step === 2) {
            app.innerHTML = `
                <div style="margin-bottom:2rem; display:flex; justify-content:space-between; align-items:flex-end;">
                    <div><h2 style="margin:0;">Ordering for: ${state.customer.name}</h2><small>${state.customer.address}</small></div>
                    <button class="btn btn-outline" onclick="state.step=1;render()">Change Account</button>
                </div>
                <div class="product-grid">${Object.values(groupedProducts).map(p => {
                    const selectId = `select-${p.name.replace(/\s+/g, '')}`;
                    const qtyId = `qty-${p.name.replace(/\s+/g, '')}`;
                    return `
                    <div class="product-card">
                        <img src="${p.img || 'https://via.placeholder.com/400x220?text=SBC+Brewing'}" class="product-img">
                        <div class="product-info">
                            <h3>${p.name}</h3>
                            <span class="format-label">Select Format</span>
                            <select class="type-select" id="${selectId}" onchange="updateCart('${p.name}', '${selectId}', '${qtyId}')">
                                ${p.options.map((opt, idx) => `<option value="${idx}">${opt.type} — $${opt.price.toFixed(2)} (${opt.stock} in stock)</option>`).join("")}
                            </select>
                            <div class="qty-container">
                                <span class="format-label" style="margin:0;">Quantity</span>
                                <input type="number" id="${qtyId}" class="qty-input" placeholder="0" min="0" 
                                oninput="updateCart('${p.name}', '${selectId}', '${qtyId}')">
                            </div>
                        </div>
                    </div>`;
                }).join("")}</div>`;
        } else if (state.step === 3) {
            const t = calculate();
            app.innerHTML = `
                <div class="card">
                    <div style="display:flex; justify-content:space-between; border-bottom:2px solid var(--bg); padding-bottom:2rem;">
                        <div>
                            <strong>BILL TO:</strong><br>
                            ${state.customer.name}<br>
                            ${state.customer.address}<br>
                            ${state.customer.city}, ${state.customer.state} ${state.customer.zip}
                        </div>
                        <div style="text-align:right;">
                            <strong style="color:var(--sbc-blue);">ORDER SUMMARY</strong><br>
                            Date: ${new Date().toLocaleDateString()}<br>
                            Rep: Remy Davis
                        </div>
                    </div>
                    <table class="review-table">
                        <thead><tr><th>Product</th><th>Format</th><th style="text-align:center;">Qty</th><th style="text-align:right;">Total</th></tr></thead>
                        <tbody>${Object.values(state.cart).map(i => `
                            <tr>
                                <td><strong>${i.beer}</strong></td>
                                <td>${i.type}</td>
                                <td style="text-align:center;">${i.qty}</td>
                                <td style="text-align:right;">$${(i.price*i.qty).toFixed(2)}</td>
                            </tr>`).join("")}</tbody>
                    </table>
                    <div style="text-align:right; font-size:1.1rem; line-height:2;">
                        Subtotal: $${t.sub.toFixed(2)}<br>
                        ${t.disc > 0 ? `<span style="color:#00b894;">Volume Discount: -$${t.disc.toFixed(2)}</span><br>` : ''}
                        Tax: $${t.tax.toFixed(2)}<br>
                        Keg Deposits: $${t.dep.toFixed(2)}<br>
                        <strong style="font-size:1.8rem; color:var(--sbc-blue);">TOTAL: $${t.final.toFixed(2)}</strong>
                    </div>
                    <div class="action-flex" style="display:flex; gap:15px; margin-top:2rem;">
                        <button class="btn btn-outline" style="flex:1" onclick="state.step=2;render()">Edit Items</button>
                        <button class="btn btn-outline" style="flex:1" onclick="handleEmailRequest()">${state.emailRequested ? 'Email Queued ✓' : 'Email Invoice'}</button>
                    </div>
                    <button class="btn btn-success btn-primary" onclick="submitOrder()">Submit Final Order</button>
                </div>`;
        }
    }

    function updateBar() {
        const t = calculate();
        document.getElementById("live-total").innerText = "$" + t.final.toFixed(2);
        document.getElementById("stock-error").style.display = t.overStock ? "block" : "none";
        document.getElementById("review-btn").disabled = t.overStock;
        document.getElementById("review-btn").style.opacity = t.overStock ? "0.5" : "1";
    }

    async function doSearch(v) {
        if (v.length < 2) return;
        const res = await fetch(`${API_URL}?q=${encodeURIComponent(v)}`);
        const data = await res.json();
        document.getElementById("results").innerHTML = data.results.map(c => `
            <div style="padding:15px; border:1px solid var(--border); border-radius:8px; margin-bottom:10px; cursor:pointer; background:#fff;" 
            onclick='selectCust(${JSON.stringify(c).replace(/'/g, "&apos;")})'>
                <strong>${c.name}</strong><br><small style="color:#636e72">${c.address}</small>
            </div>`).join("");
    }

    function handleEmailRequest() {
        if (!state.customer.email) state.customer.email = prompt("Enter Client Email Address:");
        if (state.customer.email) { state.emailRequested = true; render(); }
    }

    window.selectCust = (c) => { state.customer = c; state.step = 2; render(); };
    function goToReview() { state.step = 3; render(); }

    async function submitOrder() {
        const btn = event.target;
        btn.disabled = true; btn.innerText = "Submitting...";
        const payload = { ...state, subject: `Suburban Brewing Company Order - ${state.customer.name}` };
        await fetch(API_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(payload) });
        alert("Order Submitted! Redirecting...");
        location.reload();
    }

    init();
</script>
</body>
</html>
