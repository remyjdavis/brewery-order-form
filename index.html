<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBC Wholesale Portal</title>
    <style>
        body { font-family: sans-serif; background: #f4f4f9; margin: 0; color: #333; }
        .site-header { background: #1a1a1a; color: white; padding: 20px; text-align: center; border-bottom: 3px solid #007bff; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 800px; margin: 20px auto; width: 90%; }
        .legal-box { font-size: 0.8em; height: 300px; overflow-y: scroll; border: 1px solid #ddd; padding: 15px; background: #fafafa; margin: 15px 0; line-height: 1.6; }
        .dropdown { position: absolute; background: white; border: 1px solid #ddd; width: 100%; z-index: 100; max-height: 200px; overflow-y: auto; display: none; }
        .dropdown-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
        .dropdown-item:hover { background: #f0f7ff; }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; }
        .product-card { border: 1px solid #eee; padding: 10px; text-align: center; border-radius: 5px; }
        .qty-input { width: 60px; padding: 5px; text-align: center; border: 1px solid #007bff; border-radius: 4px; }
        .btn { padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
    </style>
</head>
<body>

<header class="site-header">
    <img src="https://raw.githubusercontent.com/remyjdavis/brewery-order-form/main/logo.png" height="50">
    <h2>Suburban Brewing Co. Wholesale</h2>
</header>

<main id="app"></main>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyT1PzljxVZ9NKBbgmAJ7kgPul228vnwrdjf_YRbzhIMR_rXhG2tx36-yzBHfFNH5DX/exec";
    let products = [];
    let state = { step: 0, customer: null, cart: [], notes: "" };

    async function init() {
        const csv = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTOYHzF6u43ORNewiUMe-i-FtSGPB4mHw-BN9xlqY-UzHvRWUVr-Cgro_kqiGm4G-fKAA6w3ErQwp3O/pub?gid=1782602603&output=csv";
        const res = await fetch(csv);
        const text = await res.text();
        products = text.split("\n").slice(1).map(r => {
            const c = r.split(",");
            return { name: c[0], price: parseFloat(c[1]) };
        });
        render();
    }

    function render() {
        const app = document.getElementById("app");
        if (state.step === 0) {
            app.innerHTML = `<div class="card">
                <h3>Wholesale Terms & Conditions</h3>
                <div class="legal-box">
                    <p><strong>1. PROVISIONS:</strong> This agreement is between Suburban Brewing Co. and the Licensee. All malt beverages are unpasteurized and must be refrigerated at 38Â°F.</p>
                    <p><strong>2. LICENSING:</strong> Purchaser warrants they hold a valid PA Liquor License. Any changes in licensure must be reported immediately.</p>
                    <p><strong>3. PAYMENTS:</strong> Payment is Net-on-Delivery. Fintech accounts draft automatically. Non-Fintech accounts must pay via business check at time of delivery.</p>
                    <p><strong>4. COOPERAGE:</strong> Kegs are property of SBC. $30 deposit per unit. Loss of keg results in $120 replacement fee.</p>
                    <p><strong>5. TAXES:</strong> 6% Sales tax applies to all retail/restaurant sales unless exempt certificate is on file.</p>
                    <p><strong>6. DELIVERY:</strong> Minimum delivery requirements may apply based on zone.</p>
                </div>
                <label><input type="checkbox" id="agree"> I agree to the Wholesale Terms</label>
                <button class="btn btn-primary" onclick="if(document.getElementById('agree').checked){state.step=1;render()}">Continue</button>
            </div>`;
        } else if (state.step === 1) {
            app.innerHTML = `<div class="card" style="position:relative;">
                <h3>Search Account</h3>
                <input type="text" id="search" placeholder="Enter Business Name..." style="width:100%; padding:10px; box-sizing:border-box;">
                <div id="results" class="dropdown"></div>
            </div>`;
            document.getElementById("search").oninput = (e) => doSearch(e.target.value);
        } else if (state.step === 2) {
            app.innerHTML = `<div class="card">
                <h3>Select Products for ${state.customer.name}</h3>
                <div class="product-grid">${products.map((p, i) => `
                    <div class="product-card">
                        <strong>${p.name}</strong><br>$${p.price.toFixed(2)}<br>
                        <input type="number" class="qty-input" min="0" onchange="updateCart('${p.name}', ${p.price}, this.value)">
                    </div>
                `).join("")}</div>
                <button class="btn btn-primary" onclick="state.step=3;render()">Review Order</button>
            </div>`;
        } else if (state.step === 3) {
            const total = state.cart.reduce((s, i) => s + (i.price * i.qty), 0);
            app.innerHTML = `<div class="card">
                <div style="float:right">${new Date().toLocaleDateString()}</div>
                <strong>Suburban Brewing Co.</strong><br>
                3041 Horseshoe Pike, Honey Brook, PA<br><br>
                <strong>SHIP TO:</strong><br>
                ${state.customer.name}<br>
                ${state.customer.address}<br>
                ${state.customer.city}, ${state.customer.state} ${state.customer.zip}<br><br>
                <hr>
                <table style="width:100%">${state.cart.map(i => `<tr><td>${i.name}</td><td>x${i.qty}</td><td style="text-align:right">$${(i.price*i.qty).toFixed(2)}</td></tr>`).join("")}</table>
                <h3 style="text-align:right">Total: $${total.toFixed(2)}</h3>
                <textarea id="notes" placeholder="Delivery notes..." style="width:100%; height:60px;"></textarea>
                <button class="btn btn-success" onclick="submitOrder()">Submit Final Order</button>
            </div>`;
        }
    }

    async function doSearch(val) {
        if (val.length < 2) return;
        const res = await fetch(`${API_URL}?q=${encodeURIComponent(val)}`);
        const data = await res.json();
        const box = document.getElementById("results");
        box.style.display = "block";
        box.innerHTML = data.results.map(c => `<div class="dropdown-item" onclick='selectCust(${JSON.stringify(c)})'>${c.name}</div>`).join("");
    }

    window.selectCust = (c) => { state.customer = c; state.step = 2; render(); };
    window.updateCart = (n, p, q) => {
        const idx = state.cart.findIndex(i => i.name === n);
        if (idx > -1) state.cart[idx].qty = parseInt(q);
        else state.cart.push({ name: n, price: p, qty: parseInt(q) });
    };

    async function submitOrder() {
        state.notes = document.getElementById("notes").value;
        await fetch(API_URL, { method: "POST", body: JSON.stringify(state) });
        alert("Order Received!");
        location.reload();
    }

    init();
</script>
</body>
</html>
