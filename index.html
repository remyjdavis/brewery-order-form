<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBC Wholesale Portal</title>
    <style>
        :root { --sbc-blue: #007bff; --sbc-dark: #1a1a1a; --bg: #f4f7f9; }
        body { font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; background: var(--bg); margin: 0; padding-bottom: 120px; color: #333; }
        
        /* PROFESSIONAL LEFT-ALIGNED HEADER */
        .site-header { background: #fff; padding: 30px 5%; border-bottom: 5px solid var(--sbc-dark); display: flex; align-items: center; gap: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .site-header img { height: 85px; }
        .header-text { text-align: left; }
        .site-header h1 { margin: 0; font-size: 1.8em; text-transform: uppercase; letter-spacing: 1px; }
        .site-header p { margin: 5px 0 0; color: #666; font-size: 0.9em; line-height: 1.4; }

        .container { max-width: 900px; margin: 40px auto; padding: 0 20px; }
        .card { background: white; padding: 40px; border-radius: 4px; border: 1px solid #e1e4e8; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        
        /* AGREEMENT BOX */
        .legal-scroll { height: 350px; overflow-y: scroll; border: 1px solid #eee; padding: 25px; background: #fafafa; font-size: 0.9em; line-height: 1.7; margin: 20px 0; border-radius: 4px; }
        
        /* LIVE BAR */
        .live-bar { position: fixed; bottom: 0; left: 0; right: 0; background: var(--sbc-dark); color: white; padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; z-index: 9999; border-top: 4px solid var(--sbc-blue); }
        .summary-flex { display: flex; gap: 30px; }
        .summary-item { text-align: left; }
        .summary-item small { display: block; color: #aaa; font-size: 0.7em; text-transform: uppercase; }
        .summary-item span { font-size: 1.2em; font-weight: bold; }

        .btn { padding: 15px 30px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; transition: 0.2s; }
        .btn-primary { background: var(--sbc-blue); color: white; width: 100%; }
        .btn-success { background: #28a745; color: white; width: 100%; font-size: 1.2em; margin-top: 20px; }
        
        .search-wrap { position: relative; width: 100%; margin: 20px 0; }
        input[type="text"] { width: 100%; padding: 15px; border: 1px solid #ccc; font-size: 1.1em; box-sizing: border-box; }
        #results { position: absolute; width: 100%; background: white; border: 1px solid #ddd; z-index: 100; box-shadow: 0 8px 16px rgba(0,0,0,0.1); display: none;}
        .dropdown-item { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; }
        .dropdown-item:hover { background: #f8f9fa; }

        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-top: 30px; }
        .product-card { border: 1px solid #eee; padding: 20px; text-align: center; }
        .qty-input { width: 60px; padding: 8px; text-align: center; font-weight: bold; border: 1px solid #ccc; }
    </style>
</head>
<body>

<header class="site-header">
    <img src="https://raw.githubusercontent.com/remyjdavis/brewery-order-form/main/logo.png" alt="SBC Logo">
    <div class="header-text">
        <h1>Suburban Brewing Co.</h1>
        <p>3041 Horseshoe Pike, Honey Brook, PA 19344<br>Remy Davis | (908) 642-1019 | remyjdavis90@gmail.com</p>
    </div>
</header>

<div class="container" id="app"></div>

<div id="live-bar" class="live-bar" style="display:none;">
    <div class="summary-flex">
        <div class="summary-item"><small>Subtotal</small><span id="live-sub">$0.00</span></div>
        <div class="summary-item"><small>Deposits</small><span id="live-dep">$0.00</span></div>
        <div class="summary-item"><small>Tax</small><span id="live-tax">$0.00</span></div>
        <div class="summary-item" style="border-left: 1px solid #444; padding-left: 25px;"><small>Total Due</small><span id="live-total" style="color:var(--sbc-blue); font-size:1.5em;">$0.00</span></div>
    </div>
    <button class="btn btn-primary" style="width:auto;" onclick="state.step=3;render()">Review Order</button>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyT1PzljxVZ9NKBbgmAJ7kgPul228vnwrdjf_YRbzhIMR_rXhG2tx36-yzBHfFNH5DX/exec";
    const PRODUCT_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTOYHzF6u43ORNewiUMe-i-FtSGPB4mHw-BN9xlqY-UzHvRWUVr-Cgro_kqiGm4G-fKAA6w3ErQwp3O/pub?gid=1782602603&output=csv";

    let products = [];
    let state = { step: 0, customer: null, cart: [] };

    async function init() {
        const res = await fetch(PRODUCT_CSV);
        const text = await res.text();
        products = text.split("\n").slice(1).map(r => {
            const c = r.split(",");
            return { name: c[0].trim(), price: parseFloat(c[1]) || 0 };
        }).filter(p => p.name);
        render();
    }

    function calculate() {
        let sub = 0, totalQty = 0, dep = 0;
        state.cart.forEach(i => {
            if (i.qty > 0) {
                sub += (i.price * i.qty);
                totalQty += i.qty;
                if (i.name.toLowerCase().includes("keg")) dep += (i.qty * 30);
            }
        });
        const disc = (totalQty >= 10) ? (sub * 0.10) : 0;
        const tax = (state.customer && state.customer.type === "Check") ? ((sub - disc) * 0.06) : 0;
        return { sub, disc, dep, tax, final: (sub - disc + dep + tax) };
    }

    function render() {
        const app = document.getElementById("app");
        const bar = document.getElementById("live-bar");
        app.innerHTML = "";
        bar.style.display = (state.step === 2) ? "flex" : "none";

        if (state.step === 0) {
            app.innerHTML = `
                <div class="card">
                    <h2 style="margin-top:0; text-align:center;">Wholesale Terms of Sale</h2>
                    <div class="legal-scroll">
                        <p><strong>1. QUALITY CONTROL:</strong> All Suburban Brewing Co. products are unpasteurized and must be maintained at a constant refrigeration temperature of 38Â°F. Suburban Brewing Co. is not liable for product spoilage due to temperature abuse at the retail level.</p>
                        <p><strong>2. LICENSURE:</strong> Purchaser warrants that they hold a valid retail liquor license. Any change in licensure status must be reported to Suburban Brewing Co. immediately.</p>
                        <p><strong>3. PAYMENTS:</strong> Payment is Net-on-Delivery. Fintech accounts are drafted automatically. Non-fintech accounts must provide a business check at the time of delivery.</p>
                        <p><strong>4. COOPERAGE:</strong> All kegs remain the property of Suburban Brewing Co. A $30.00 deposit is required for each unit. Lost or damaged kegs will be billed at $120.00 per unit.</p>
                        <p><strong>5. TAXATION & DISCOUNTS:</strong> A 6% PA Sales Tax is applied only to restaurant (non-fintech) accounts. A 10% volume discount is applied to orders of 10 units or more.</p>
                        <p><strong>6. ACCEPTANCE:</strong> By proceeding with this order, the purchaser agrees to all terms and conditions stated above.</p>
                    </div>
                    <label style="display:block; margin-bottom:20px; cursor:pointer; text-align:center;">
                        <input type="checkbox" id="agree"> I agree to the Suburban Brewing Co. Wholesale Terms.
                    </label>
                    <button class="btn btn-primary" onclick="if(document.getElementById('agree').checked){state.step=1;render()}">Accept & Enter Portal</button>
                </div>`;
        } else if (state.step === 1) {
            app.innerHTML = `
                <div class="card">
                    <h2>Select Business Account</h2>
                    <div class="search-wrap">
                        <input type="text" id="cust-search" placeholder="Type business name..." autocomplete="off">
                        <div id="results"></div>
                    </div>
                </div>`;
            document.getElementById("cust-search").oninput = (e) => doSearch(e.target.value);
        } else if (state.step === 2) {
            app.innerHTML = `
                <div class="card">
                    <h3>Ordering for: ${state.customer.name}</h3>
                    <div class="product-grid">${products.map(p => `
                        <div class="product-card">
                            <strong>${p.name}</strong><br>$${p.price.toFixed(2)}<br><br>
                            <input type="number" class="qty-input" min="0" value="${getQty(p.name)}" oninput="updateCart('${p.name}', ${p.price}, this.value)">
                        </div>`).join("")}</div>
                </div>`;
            updateBar();
        } else if (state.step === 3) {
            const t = calculate();
            const items = state.cart.filter(i => i.qty > 0);
            app.innerHTML = `
                <div class="card">
                    <div style="color:var(--sbc-blue); font-weight:bold; margin-bottom:10px; text-transform:uppercase;">Suburban Brewing Co.</div>
                    <div style="display:flex; justify-content:space-between; align-items:start;">
                        <div>
                            <div style="font-weight:900; font-size:1.6em; margin-bottom:5px;">${state.customer.name}</div>
                            <div style="font-size:1.1em; line-height:1.4;">
                                ${state.customer.address}<br>
                                ${state.customer.city}, ${state.customer.state} ${state.customer.zip}
                            </div>
                        </div>
                        <div style="text-align:right;">
                            <div style="color:#666; font-size:0.8em; text-transform:uppercase;">ORDER DATE</div>
                            <div style="font-weight:bold; font-size:1.2em;">${new Date().toLocaleDateString()}</div>
                        </div>
                    </div>
                    <hr style="margin:30px 0; border:0; border-top:2px solid #333;">
                    <table style="width:100%; border-collapse:collapse;">
                        ${items.map(i => `<tr style="border-bottom:1px solid #eee;"><td style="padding:12px 0;">${i.name}</td><td style="text-align:center;">x${i.qty}</td><td style="text-align:right;">$${(i.price*i.qty).toFixed(2)}</td></tr>`).join("")}
                    </table>
                    <div style="text-align:right; margin-top:30px; font-size:1.1em; line-height:1.6;">
                        Subtotal: $${t.sub.toFixed(2)}<br>
                        ${t.disc > 0 ? `<span style="color:#d9534f;">Discount: -$${t.disc.toFixed(2)}</span><br>` : ''}
                        Keg Deposits ($30/ea): $${t.dep.toFixed(2)}<br>
                        PA Sales Tax (6%): $${t.tax.toFixed(2)}<br>
                        <strong style="font-size:1.8em; display:block; margin-top:10px;">Total Due: $${t.final.toFixed(2)}</strong>
                    </div>
                    <button class="btn btn-success" onclick="submitOrder()">Submit Final Order</button>
                </div>`;
        }
    }

    async function doSearch(val) {
        if (val.length < 2) return;
        const res = await fetch(`${API_URL}?q=${encodeURIComponent(val)}`);
        const data = await res.json();
        const box = document.getElementById("results");
        box.style.display = "block";
        box.innerHTML = data.results.map(c => `<div class="dropdown-item" onclick='selectCust(${JSON.stringify(c).replace(/'/g, "&apos;")})'><strong>${c.name}</strong><br><small>${c.address}</small></div>`).join("");
    }

    window.selectCust = (c) => { state.customer = c; state.step = 2; render(); };
    function updateCart(name, price, qty) {
        const idx = state.cart.findIndex(i => i.name === name);
        const q = parseInt(qty) || 0;
        if (idx > -1) state.cart[idx].qty = q;
        else state.cart.push({name, price, qty: q});
        updateBar();
    }
    function updateBar() {
        const t = calculate();
        document.getElementById("live-sub").innerText = "$" + t.sub.toFixed(2);
        document.getElementById("live-dep").innerText = "$" + t.dep.toFixed(2);
        document.getElementById("live-tax").innerText = "$" + t.tax.toFixed(2);
        document.getElementById("live-total").innerText = "$" + t.final.toFixed(2);
    }
    function getQty(name) { const i = state.cart.find(c => c.name === name); return i ? i.qty : 0; }
    
    async function submitOrder() {
        const payload = { ...state, totals: calculate() };
        await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) });
        alert("Order Submitted Successfully!");
        location.reload();
    }

    init();
</script>
</body>
</html>
