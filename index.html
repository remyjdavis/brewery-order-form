<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>SBC Wholesale Portal</title>
  <style>
    body { font-family: -apple-system, system-ui, sans-serif; background: #f4f4f9; margin: 0; padding-bottom: 140px; color: #333; }
    
    .site-header { 
      background: #1a1a1a; color: white; padding: 20px 5%; display: flex; align-items: center; justify-content: space-between;
      border-bottom: 4px solid #007bff; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    .header-brand { display: flex; align-items: center; gap: 20px; }
    .header-brand img { height: 75px; background: white; border-radius: 4px; padding: 2px; }

    /* MASSIVE LONG-FORM USER AGREEMENT */
    .agreement-card { background: white; padding: 50px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); width: 92%; max-width: 900px; margin: 40px auto; border: 4px solid #007bff; }
    .agreement-title { font-size: 2.8em; color: #1a1a1a; margin-bottom: 20px; border-bottom: 8px solid #007bff; display: inline-block; text-transform: uppercase; text-align: center; width: 100%; }
    .agreement-box { 
      text-align: left; background: #f9f9f9; border: 1px solid #ddd; padding: 35px; border-radius: 12px; 
      font-size: 1.2em; line-height: 1.5; color: #1a1a1a; margin-bottom: 40px; 
      max-height: 400px; overflow-y: scroll; /* For very long legal text */
    }

    /* PRODUCT GRID */
    .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); width: 92%; max-width: 1000px; margin: 20px auto; }
    .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 20px; }
    .product-card { border: 1px solid #eee; padding: 20px; border-radius: 12px; background: #fff; text-align: center; }
    .qty-input { width: 90%; padding: 15px; border: 2px solid #007bff; border-radius: 8px; text-align: center; font-weight: bold; font-size: 1.5em; }
    
    /* LIVE BAR */
    .live-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #1a1a1a; color: white; border-top: 5px solid #007bff; padding: 25px 5%; display: flex; justify-content: space-between; align-items: center; z-index: 1000; }
    #savings-label { color: #2ecc71; font-size: 1.5em; font-weight: 900; display: block; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
    #live-total { font-size: 2.8em; display: block; line-height: 1; font-weight: 800; }

    button { padding: 22px 45px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; font-size: 1.4em; }
    .primary { background: #007bff; color: white; width: 100%; }
    .success { background: #28a745; color: white; width: 100%; }
    .secondary { background: #eee; color: #444; width: 100%; margin-top: 15px; }
    
    .override-input { width: 110px; padding: 10px; border: 2px solid #ffc107; background: #fffde7; text-align: right; font-weight: bold; border-radius: 8px; margin-top: 15px; }
    .dropdown { position: absolute; width: 100%; background: white; border: 1px solid #ddd; z-index: 5000; display: none; }
    .dropdown-item { padding: 22px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 1.4em; }

    .summary-row { display: flex; justify-content: flex-end; padding: 10px 0; font-size: 1.4em; }
    .summary-label { width: 320px; text-align: right; color: #666; padding-right: 30px; }
    .summary-val { width: 160px; text-align: right; font-weight: bold; }
    .grand-total { border-top: 6px solid #1a1a1a; margin-top: 20px; padding-top: 20px; font-size: 2.6em; color: #1a1a1a; }
  </style>
</head>
<body>

<header class="site-header">
  <div class="header-brand">
    <img src="https://raw.githubusercontent.com/remyjdavis/brewery-order-form/main/logo.png" alt="SBC" onerror="this.src='https://via.placeholder.com/80'">
    <div>
      <h1 style="margin:0; text-transform:uppercase; font-size:1.4em;">Suburban Brewing Co.</h1>
      <p style="margin:2px 0; opacity:0.8; font-size:0.9em;">Wholesale Portal | Rep: Remy Davis</p>
    </div>
  </div>
</header>

<main id="app"></main>

<div id="live-bar" class="live-bar" style="display:none;">
  <div>
    <small id="savings-label"></small>
    <strong id="live-total">$0.00</strong>
  </div>
  <button style="background:#007bff; color:white; padding: 25px 50px;" onclick="state.step=3;render()">Review Order &rarr;</button>
</div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbyT1PzljxVZ9NKBbgmAJ7kgPul228vnwrdjf_YRbzhIMR_rXhG2tx36-yzBHfFNH5DX/exec";
  const PRODUCT_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTOYHzF6u43ORNewiUMe-i-FtSGPB4mHw-BN9xlqY-UzHvRWUVr-Cgro_kqiGm4G-fKAA6w3ErQwp3O/pub?gid=1782602603&single=true&output=csv";
  const OVERRIDE_PW = "Yankees1";
  const BULK_THRESHOLD = 10; 
  const BULK_DISCOUNT_PERCENT = 0.10; 

  let products = [];
  let state = { step: 0, customer: null, cart: [], overrideMode: false };

  async function init() {
    try {
      const res = await fetch(`${PRODUCT_CSV_URL}&t=${Date.now()}`);
      const text = await res.text();
      const rows = text.split("\n").slice(1);
      products = rows.map(r => {
        const c = r.split(",");
        const p = parseFloat(c[1]) || 0;
        return { name: (c[0]||"").trim(), price: p, originalPrice: p };
      }).filter(p => p.name);
      render();
    } catch(e) { console.error(e); }
  }

  function render() {
    const app = document.getElementById("app");
    const bar = document.getElementById("live-bar");
    app.innerHTML = ""; bar.style.display = "none";

    if (state.step === 0) {
      app.innerHTML = `<div class="agreement-card">
        <h2 class="agreement-title">Wholesale Terms & Conditions</h2>
        <div class="agreement-box">
          <p><strong>1. PROOF OF LICENSE:</strong> By accessing this portal, the Customer represents and warrants that they hold a valid PA Liquor License and all necessary permits for the purchase and resale of malt and brewed beverages. Suburban Brewing Co. (SBC) reserves the right to request proof of licensure at any time.</p>
          <p><strong>2. PRICING & CONFIDENTIALITY:</strong> All wholesale pricing provided herein is strictly confidential and proprietary to SBC. Unauthorized disclosure of wholesale pricing to third parties or retail customers is strictly prohibited and may result in immediate termination of wholesale privileges.</p>
          <p><strong>3. PAYMENTS & DEPOSITS:</strong> A $30.00 deposit is required for each keg (1/2bbl, 1/6bbl) provided. All payments are due upon delivery unless credit terms have been formally established and approved in writing by SBC management.</p>
          <p><strong>4. BULK DISCOUNT ELIGIBILITY:</strong> A bulk discount of 10% is automatically applied to orders where the total quantity of cases/units equals ten (10) or more. SBC reserves the right to modify or revoke bulk pricing at any time without notice.</p>
          <p><strong>5. INSPECTION & RETURNS:</strong> Customers must inspect all products upon delivery. Claims for shortages, damaged goods, or quality issues must be made at the time of delivery. Once delivery is accepted, SBC is not responsible for damages occurring at the customer's location.</p>
          <p><strong>6. COMPLIANCE:</strong> Customer agrees to comply with all local, state, and federal laws regarding the sale and service of alcohol.</p>
        </div>
        <label style="font-size: 1.8em; cursor:pointer; display:block; margin-bottom:40px; font-weight:bold; text-align:center;">
          <input type="checkbox" id="agree-check" style="transform: scale(3); margin-right: 25px;" onchange="document.getElementById('start-btn').disabled = !this.checked"> 
          I AGREE TO THE ABOVE TERMS
        </label>
        <button id="start-btn" class="primary" style="padding:35px;" disabled onclick="state.step=1;render()">Proceed to Portal</button>
      </div>`;
    } 
    // ... rest of the app logic follows (Step 1, 2, 3 as previously provided)
    else if (state.step === 1) {
      app.innerHTML = `<div class="card">
        <h2 style="font-size:2em;">Account Selection</h2>
        <input type="text" id="cust-input" placeholder="Search account name..." style="width:100%; padding:25px; border-radius:10px; border:3px solid #ddd; font-size:1.6em;">
        <div id="results" class="dropdown"></div>
      </div>`;
      document.getElementById("cust-input").oninput = (e) => doSearch(e.target.value);
    } 
    else if (state.step === 2) {
      bar.style.display = "flex";
      app.innerHTML = `<div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
            <h3 style="margin:0; font-size:1.8em; color:#007bff;">${state.customer.name}</h3>
            <button style="background:#f8f9fa; border:1px solid #ccc; padding:10px 20px;" onclick="toggleOverride()">Override</button>
        </div>
        <div class="product-grid">${products.map((p, i) => `
          <div class="product-card">
            <span style="font-weight:800; display:block; height:50px; font-size:1.4em;">${p.name}</span>
            <span style="color:#007bff; font-weight:900; display:block; margin:15px 0; font-size:1.5em;">$${p.price.toFixed(2)}</span>
            <input type="number" class="qty-input" min="0" placeholder="0" value="${getQty(p.name) || ''}" oninput="updateCart(${i}, this.value)">
            ${state.overrideMode ? `<br><input type="number" step="0.01" class="override-input" value="${p.price}" oninput="updateOverridePrice('${p.name}', this.value)">` : ''}
          </div>`).join("")}
        </div>
      </div>`;
      updateLiveDisplay();
    }
    else if (state.step === 3) {
      const items = state.cart.filter(i => i.qty > 0);
      const subtotal = calculateSubtotal();
      const discount = calculateDiscount();
      const kegCount = items.reduce((s, i) => {
        const n = i.name.toLowerCase();
        return s + (n.includes("keg") || n.includes("1/2bbl") || n.includes("1/6bbl") ? i.qty : 0);
      }, 0);
      const kegDeposit = kegCount * 30.00;
      const grandTotal = (subtotal - discount) + kegDeposit;

      app.innerHTML = `<div class="card">
        <h2 style="font-size:2.4em; border-bottom:5px solid #007bff; padding-bottom:15px;">Final Review</h2>
        <div style="margin:25px 0; font-size:1.5em; font-weight:bold;">${state.customer.name}</div>
        <table style="width:100%; border-collapse:collapse; margin-bottom:30px;">
            ${items.map(item => `
            <tr>
                <td style="padding:20px 0; border-bottom:1px solid #eee; font-size:1.3em;">${item.name} (x${item.qty})</td>
                <td style="text-align:right; padding:20px 0; border-bottom:1px solid #eee; font-weight:bold; font-size:1.3em;">$${(item.price * item.qty).toFixed(2)}</td>
            </tr>`).join("")}
        </table>
        <div class="summary-area">
            <div class="summary-row"><div class="summary-label">Subtotal:</div><div class="summary-val">$${subtotal.toFixed(2)}</div></div>
            ${discount > 0 ? `<div class="summary-row" style="color:#2ecc71; font-weight:900;"><div class="summary-label">Bulk Case Discount (10%):</div><div class="summary-val">-$${discount.toFixed(2)}</div></div>` : ''}
            ${kegDeposit > 0 ? `<div class="summary-row"><div class="summary-label">Keg Deposits:</div><div class="summary-val">$${kegDeposit.toFixed(2)}</div></div>` : ''}
            <div class="summary-row grand-total"><div class="summary-label">Total Due:</div><div class="summary-val">$${grandTotal.toFixed(2)}</div></div>
        </div>
        <button class="success" style="margin-top:45px; padding:35px;" onclick="submitOrder()">Submit Final Order</button>
        <button class="secondary" onclick="state.step=2;render()">‚Üê Back to Shop</button>
      </div>`;
    }
  }

  function toggleOverride() {
    if (prompt("Enter Sales Rep Code:") === OVERRIDE_PW) { 
        state.overrideMode = !state.overrideMode; render(); 
    }
  }

  function updateCart(idx, qty) {
    const p = products[idx];
    const q = Math.max(0, parseInt(qty) || 0);
    let item = state.cart.find(i => i.name === p.name);
    if (item) item.qty = q; else state.cart.push({...p, qty: q});
    updateLiveDisplay();
  }

  function updateOverridePrice(name, val) {
    const newPrice = parseFloat(val) || 0;
    let p = products.find(prod => prod.name === name);
    p.price = newPrice;
    let itemInCart = state.cart.find(i => i.name === name);
    if (itemInCart) itemInCart.price = newPrice;
    updateLiveDisplay();
  }

  function updateLiveDisplay() {
    const subtotal = calculateSubtotal();
    const discount = calculateDiscount();
    document.getElementById("live-total").innerText = "$" + (subtotal - discount).toFixed(2);
    
    const label = document.getElementById("savings-label");
    const totalQty = state.cart.reduce((s, i) => s + i.qty, 0);
    
    if (discount > 0) {
        label.innerText = `Bulk Discount Applied (${totalQty} cases): -$${discount.toFixed(2)}`;
    } else {
        label.innerText = "";
    }
  }

  function calculateSubtotal() { return state.cart.reduce((s, i) => s + (i.price * i.qty), 0); }
  
  function calculateDiscount() { 
    const totalQty = state.cart.reduce((s, i) => s + i.qty, 0);
    if (totalQty >= BULK_THRESHOLD) {
        return calculateSubtotal() * BULK_DISCOUNT_PERCENT;
    }
    return 0;
  }

  function getQty(name) { let i = state.cart.find(c => c.name === name); return i ? i.qty : 0; }

  async function doSearch(val) {
    const box = document.getElementById("results");
    if (val.length < 2) { box.style.display="none"; return; }
    const res = await fetch(`${API_URL}?q=${encodeURIComponent(val)}`);
    const data = await res.json();
    box.style.display = "block";
    box.innerHTML = data.results.map(c => `<div class="dropdown-item" onmousedown='setCustomer(${JSON.stringify(c).replace(/'/g, "&apos;")})'>${c.name}</div>`).join("");
  }

  function setCustomer(c) { state.customer = c; state.step = 2; render(); }

  async function submitOrder() {
    const btn = document.querySelector(".success");
    btn.innerText = "Processing..."; btn.disabled = true;
    await fetch(API_URL, { method: "POST", body: JSON.stringify({ customer: state.customer, items: state.cart.filter(i => i.qty > 0) }) });
    alert("Order Submitted Successfully!"); location.reload();
  }

  init();
</script>
</body>
</html>
